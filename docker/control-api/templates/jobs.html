{% extends "base.html" %}

{% block title %}–ê–≤—Ç–æ-–ø—Ä–æ–≥—Ä–µ–≤ - Telegram Farm{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1 class="page-title">ü§ñ –ê–≤—Ç–æ-–ø—Ä–æ–≥—Ä–µ–≤</h1>
        <div>
            <button id="auto-warmup-btn" class="btn btn-lg" onclick="toggleAutoWarmup()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 30px; font-size: 16px;">
                ‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å
            </button>
        </div>
    </div>
    
    <!-- –°—Ç–∞—Ç—É—Å -->
    <div class="card" style="margin-bottom: 20px; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);">
        <div class="card-body" style="padding: 20px;">
            <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 20px;">
                <div>
                    <h2 style="margin: 0; color: white;">–°–∏–º—É–ª—è—Ç–æ—Ä –∂–∏–≤–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞</h2>
                    <p style="color: #aaa; margin: 10px 0 0;">–ö–∞–∂–¥—ã–π –∞–∫–∫–∞—É–Ω—Ç –≤–µ–¥—ë—Ç —Å–µ–±—è –∫–∞–∫ —Ä–µ–∞–ª—å–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º</p>
                </div>
                <div id="status-badge" style="padding: 10px 25px; border-radius: 25px; font-size: 14px; font-weight: bold; background: #333; color: #888;">
                    ‚è∏Ô∏è –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
                </div>
            </div>
        </div>
    </div>
    
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">üë•</div>
            <div class="stat-info">
                <h3 id="total-personas">0</h3>
                <p>–í—Å–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–æ–≤</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üü¢</div>
            <div class="stat-info">
                <h3 id="active-now">0</h3>
                <p>–ê–∫—Ç–∏–≤–Ω—ã —Å–µ–π—á–∞—Å</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üìä</div>
            <div class="stat-info">
                <h3 id="actions-today">0</h3>
                <p>–î–µ–π—Å—Ç–≤–∏–π —Å–µ–≥–æ–¥–Ω—è</p>
            </div>
        </div>
    </div>
    
    <!-- –°–ø–∏—Å–æ–∫ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ —Å –ø–µ—Ä—Å–æ–Ω–∞–º–∏ -->
    <div class="card" style="margin-top: 20px;">
        <div class="card-header">
            <h2>üë• –ê–∫–∫–∞—É–Ω—Ç—ã –∏ –∏—Ö –ø–µ—Ä—Å–æ–Ω—ã</h2>
            <button class="btn btn-sm" onclick="loadPersonas()">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
        <div class="card-body">
            <div id="personas-list" class="table-container">
                <p class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
        </div>
    </div>
    
    <!-- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω -->
    <div class="card" style="margin-top: 20px;">
        <div class="card-header">
            <h2>üé≠ –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω</h2>
        </div>
        <div class="card-body">
            <div id="lifestyles-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                <p class="empty">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>
            </div>
        </div>
    </div>
    
    <!-- Live –ª–æ–≥ -->
    <div class="card" style="margin-top: 20px;">
        <div class="card-header">
            <h2>üì° Live –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h2>
            <button class="btn btn-sm" onclick="clearLogs()" style="background: #dc3545;">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
        <div id="live-logs" style="
            height: 300px;
            overflow-y: auto;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            padding: 15px;
            background: #0f0f23;
            color: #00ff00;
        ">
            <div style="color: #666;">–û–∂–∏–¥–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏...</div>
        </div>
    </div>
    
    <!-- –û–ø–∏—Å–∞–Ω–∏–µ —Å—Ç–∏–ª–µ–π –∂–∏–∑–Ω–∏ -->
    <div class="card" style="margin-top: 20px;">
        <div class="card-header">
            <h2>üìã –°—Ç–∏–ª–∏ –∂–∏–∑–Ω–∏</h2>
        </div>
        <div class="card-body">
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
                <div class="lifestyle-card" style="background: #1a1a2e; padding: 15px; border-radius: 10px;">
                    <h4>üëî Worker (–†–∞–±–æ—Ç–Ω–∏–∫)</h4>
                    <p style="color: #aaa; font-size: 13px;">–ê–∫—Ç–∏–≤–µ–Ω: —É—Ç—Ä–æ–º (7-8), –≤ –æ–±–µ–¥ (12-13), –≤–µ—á–µ—Ä–æ–º (18-21). –í—ã—Ö–æ–¥–Ω—ã–µ - –≤–µ—Å—å –¥–µ–Ω—å.</p>
                </div>
                <div class="lifestyle-card" style="background: #1a1a2e; padding: 15px; border-radius: 10px;">
                    <h4>üéì Student (–°—Ç—É–¥–µ–Ω—Ç)</h4>
                    <p style="color: #aaa; font-size: 13px;">–ê–∫—Ç–∏–≤–µ–Ω –≤–µ—Å—å –¥–µ–Ω—å, –æ—Å–æ–±–µ–Ω–Ω–æ –≤–µ—á–µ—Ä–æ–º (20-22). –ú–Ω–æ–≥–æ GIF –∏ –º–µ–º–æ–≤.</p>
                </div>
                <div class="lifestyle-card" style="background: #1a1a2e; padding: 15px; border-radius: 10px;">
                    <h4>üíª Freelancer (–§—Ä–∏–ª–∞–Ω—Å–µ—Ä)</h4>
                    <p style="color: #aaa; font-size: 13px;">–•–∞–æ—Ç–∏—á–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å 10 –¥–æ 21. –ò–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç—Å—è IT –∏ –±–∏–∑–Ω–µ—Å–æ–º.</p>
                </div>
                <div class="lifestyle-card" style="background: #1a1a2e; padding: 15px; border-radius: 10px;">
                    <h4>ü¶â Night Owl (–°–æ–≤–∞)</h4>
                    <p style="color: #aaa; font-size: 13px;">–ê–∫—Ç–∏–≤–µ–Ω –ø–æ–∑–¥–Ω–æ –≤–µ—á–µ—Ä–æ–º (21-23) –∏ –Ω–æ—á—å—é. –ò–≥—Ä—ã, —Ñ–∏–ª—å–º—ã, –∞–Ω–∏–º–µ.</p>
                </div>
                <div class="lifestyle-card" style="background: #1a1a2e; padding: 15px; border-radius: 10px;">
                    <h4>üê¶ Early Bird (–ñ–∞–≤–æ—Ä–æ–Ω–æ–∫)</h4>
                    <p style="color: #aaa; font-size: 13px;">–ê–∫—Ç–∏–≤–µ–Ω —Ä–∞–Ω–æ —É—Ç—Ä–æ–º (6-9). –°–ø–æ—Ä—Ç, –∑–¥–æ—Ä–æ–≤—å–µ, –Ω–æ–≤–æ—Å—Ç–∏.</p>
                </div>
                <div class="lifestyle-card" style="background: #1a1a2e; padding: 15px; border-radius: 10px;">
                    <h4>üè† Housewife (–î–æ–º–æ—Ö–æ–∑—è–π–∫–∞)</h4>
                    <p style="color: #aaa; font-size: 13px;">–ê–∫—Ç–∏–≤–Ω–∞ –≤–µ—Å—å –¥–µ–Ω—å —Å –ø–µ—Ä–µ—Ä—ã–≤–∞–º–∏. –†–µ—Ü–µ–ø—Ç—ã, –¥–µ—Ç–∏, —à–æ–ø–ø–∏–Ω–≥.</p>
                </div>
                <div class="lifestyle-card" style="background: #1a1a2e; padding: 15px; border-radius: 10px;">
                    <h4>üë¥ Retired (–ü–µ–Ω—Å–∏–æ–Ω–µ—Ä)</h4>
                    <p style="color: #aaa; font-size: 13px;">–†–∞–∑–º–µ—Ä–µ–Ω–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (8-19). –ù–æ–≤–æ—Å—Ç–∏, –∑–¥–æ—Ä–æ–≤—å–µ, –ø—Ä–∏—Ä–æ–¥–∞.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.lifestyle-card h4 {
    margin: 0 0 10px;
    color: white;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
    let autoWarmupActive = false;
    
    async function loadStatus() {
        try {
            const res = await fetch('/api/v1/life/status');
            const data = await res.json();
            
            autoWarmupActive = data.auto_warmup_active;
            
            // –û–±–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É –∏ —Å—Ç–∞—Ç—É—Å
            const btn = document.getElementById('auto-warmup-btn');
            const badge = document.getElementById('status-badge');
            
            if (autoWarmupActive) {
                btn.innerHTML = '‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
                btn.style.background = '#dc3545';
                badge.innerHTML = 'üü¢ –ê–∫—Ç–∏–≤–µ–Ω';
                badge.style.background = '#28a745';
                badge.style.color = 'white';
            } else {
                btn.innerHTML = '‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å';
                btn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                badge.innerHTML = '‚è∏Ô∏è –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
                badge.style.background = '#333';
                badge.style.color = '#888';
            }
            
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            document.getElementById('total-personas').textContent = data.total_personas || 0;
            document.getElementById('active-now').textContent = data.active_now || 0;
            
            // –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∏–ª–µ–π –∂–∏–∑–Ω–∏
            const lifestyles = data.lifestyles || {};
            const grid = document.getElementById('lifestyles-grid');
            
            const icons = {
                'worker': 'üëî',
                'student': 'üéì',
                'freelancer': 'üíª',
                'night_owl': 'ü¶â',
                'early_bird': 'üê¶',
                'housewife': 'üè†',
                'retired': 'üë¥'
            };
            
            const names = {
                'worker': '–†–∞–±–æ—Ç–Ω–∏–∫–∏',
                'student': '–°—Ç—É–¥–µ–Ω—Ç—ã',
                'freelancer': '–§—Ä–∏–ª–∞–Ω—Å–µ—Ä—ã',
                'night_owl': '–°–æ–≤—ã',
                'early_bird': '–ñ–∞–≤–æ—Ä–æ–Ω–∫–∏',
                'housewife': '–î–æ–º–æ—Ö–æ–∑—è–π–∫–∏',
                'retired': '–ü–µ–Ω—Å–∏–æ–Ω–µ—Ä—ã'
            };
            
            let html = '';
            for (const [style, count] of Object.entries(lifestyles)) {
                if (count > 0) {
                    html += `
                        <div style="background: linear-gradient(135deg, #2d2d44 0%, #1a1a2e 100%); padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 30px;">${icons[style] || 'üë§'}</div>
                            <div style="font-size: 24px; font-weight: bold; margin: 5px 0;">${count}</div>
                            <div style="color: #aaa; font-size: 12px;">${names[style] || style}</div>
                        </div>
                    `;
                }
            }
            
            if (html) {
                grid.innerHTML = html;
            } else {
                grid.innerHTML = '<p style="color: #666;">–ü–µ—Ä—Å–æ–Ω—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∞–∫–∫–∞—É–Ω—Ç–æ–≤</p>';
            }
            
        } catch (error) {
            console.error('Status error:', error);
        }
    }
    
    async function toggleAutoWarmup() {
        try {
            const endpoint = autoWarmupActive ? '/api/v1/life/auto-warmup/stop' : '/api/v1/life/auto-warmup/start';
            const res = await fetch(endpoint, { method: 'POST' });
            const data = await res.json();
            
            if (res.ok) {
                addLog(data.message, 'success');
            } else {
                addLog('–û—à–∏–±–∫–∞: ' + data.detail, 'error');
            }
            
            loadStatus();
        } catch (error) {
            addLog('–û—à–∏–±–∫–∞: ' + error.message, 'error');
        }
    }
    
    function addLog(message, type = 'info') {
        const container = document.getElementById('live-logs');
        const time = new Date().toLocaleTimeString();
        
        const colors = {
            'success': '#28a745',
            'error': '#dc3545',
            'warning': '#ffc107',
            'info': '#17a2b8'
        };
        
        const icons = {
            'success': '‚úÖ',
            'error': '‚ùå',
            'warning': '‚ö†Ô∏è',
            'info': 'üìù'
        };
        
        const div = document.createElement('div');
        div.style.color = colors[type] || '#fff';
        div.innerHTML = `[${time}] ${icons[type] || ''} ${message}`;
        
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
        
        // –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –ª–æ–≥–∏
        while (container.children.length > 100) {
            container.removeChild(container.firstChild);
        }
    }
    
    function clearLogs() {
        document.getElementById('live-logs').innerHTML = '<div style="color: #666;">–õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã</div>';
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞
    async function loadLogs() {
        try {
            const res = await fetch('/api/v1/live-logs');
            const data = await res.json();
            
            if (data.logs && data.logs.length > 0) {
                const container = document.getElementById('live-logs');
                const currentCount = container.children.length;
                
                // –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –ª–æ–≥–∏
                for (let i = Math.max(0, data.logs.length - 20); i < data.logs.length; i++) {
                    const log = data.logs[i];
                    if (i >= currentCount - 1) {
                        const type = log.level || 'info';
                        const msg = log.message || log;
                        addLog(typeof msg === 'string' ? msg : JSON.stringify(msg), type);
                    }
                }
            }
        } catch (e) {}
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–µ—Ä—Å–æ–Ω
    async function loadPersonas() {
        try {
            const res = await fetch('/api/v1/life/personas');
            const data = await res.json();
            
            if (!res.ok) {
                document.getElementById('personas-list').innerHTML = '<p class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
                return;
            }
            
            const personas = data.personas || [];
            const container = document.getElementById('personas-list');
            
            if (personas.length === 0) {
                container.innerHTML = '<p class="empty">–ù–µ—Ç –ø–µ—Ä—Å–æ–Ω. –ü–µ—Ä—Å–æ–Ω—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∞–∫–∫–∞—É–Ω—Ç–æ–≤.</p>';
                return;
            }
            
            const lifestyleIcons = {
                'worker': 'üëî',
                'student': 'üéì',
                'freelancer': 'üíª',
                'night_owl': 'ü¶â',
                'early_bird': 'üê¶',
                'housewife': 'üè†',
                'retired': 'üë¥'
            };
            
            const lifestyleNames = {
                'worker': '–†–∞–±–æ—Ç–Ω–∏–∫',
                'student': '–°—Ç—É–¥–µ–Ω—Ç',
                'freelancer': '–§—Ä–∏–ª–∞–Ω—Å–µ—Ä',
                'night_owl': '–°–æ–≤–∞',
                'early_bird': '–ñ–∞–≤–æ—Ä–æ–Ω–æ–∫',
                'housewife': '–î–æ–º–æ—Ö–æ–∑—è–π–∫–∞',
                'retired': '–ü–µ–Ω—Å–∏–æ–Ω–µ—Ä'
            };
            
            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                            <th>–ò–º—è</th>
                            <th>–ü–µ—Ä—Å–æ–Ω–∞</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏–π</th>
                            <th>–ò–Ω—Ç–µ—Ä–µ—Å—ã</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            for (const persona of personas) {
                const isActive = persona.is_active;
                const shouldBeActive = persona.should_be_active;
                const activityLevel = persona.activity_level || 0;
                
                let statusHtml = '';
                if (isActive) {
                    statusHtml = '<span style="color: #28a745; font-weight: bold;">üü¢ –ê–∫—Ç–∏–≤–µ–Ω</span>';
                } else if (shouldBeActive) {
                    statusHtml = '<span style="color: #ffc107;">üü° –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –∞–∫—Ç–∏–≤–µ–Ω</span>';
                } else {
                    statusHtml = '<span style="color: #6c757d;">‚ö™ –ù–µ–∞–∫—Ç–∏–≤–µ–Ω</span>';
                }
                
                const activityBar = `
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <div style="flex: 1; height: 8px; background: #333; border-radius: 4px; overflow: hidden;">
                            <div style="height: 100%; width: ${activityLevel}%; background: linear-gradient(90deg, #28a745, #20c997); transition: width 0.3s;"></div>
                        </div>
                        <span style="font-size: 11px; color: #aaa;">${activityLevel}%</span>
                    </div>
                `;
                
                html += `
                    <tr style="${isActive ? 'background: rgba(40, 167, 69, 0.1);' : ''}">
                        <td><code>${persona.phone}</code></td>
                        <td><strong>${persona.name || '-'}</strong></td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 20px;">${lifestyleIcons[persona.lifestyle] || 'üë§'}</span>
                                <div>
                                    <div style="font-weight: bold;">${lifestyleNames[persona.lifestyle] || persona.lifestyle}</div>
                                    <small style="color: #aaa;">${persona.persona_name}</small>
                                </div>
                            </div>
                        </td>
                        <td>${statusHtml}</td>
                        <td style="min-width: 120px;">${activityBar}</td>
                        <td>
                            <div>–°–µ–≥–æ–¥–Ω—è: <strong>${persona.actions_today || 0}</strong></div>
                            <small style="color: #aaa;">–í—Å–µ–≥–æ: ${persona.total_actions || 0}</small>
                        </td>
                        <td>
                            <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                                ${(persona.interests || []).map(i => `<span style="background: #2d2d44; padding: 2px 8px; border-radius: 10px; font-size: 11px;">${i}</span>`).join('')}
                            </div>
                            ${persona.favorite_channels && persona.favorite_channels.length > 0 ? 
                                `<div style="margin-top: 5px; font-size: 11px; color: #aaa;">üì∫ ${persona.favorite_channels.join(', ')}</div>` : ''}
                        </td>
                    </tr>
                `;
            }
            
            html += '</tbody></table>';
            container.innerHTML = html;
            
        } catch (error) {
            console.error('Personas error:', error);
            document.getElementById('personas-list').innerHTML = '<p class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message + '</p>';
        }
    }
    
    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    setInterval(loadStatus, 3000);
    setInterval(loadLogs, 2000);
    setInterval(loadPersonas, 5000);
    
    // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    loadStatus();
    loadPersonas();
</script>
{% endblock %}
