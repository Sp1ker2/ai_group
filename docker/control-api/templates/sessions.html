{% extends "base.html" %}

{% block title %}Sessions - Telegram Farm{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1 class="page-title">Sessions</h1>
        <div>
            <button class="btn btn-primary" onclick="showGetCodeModal()">üì± –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥</button>
            <button class="btn btn-secondary" onclick="refreshSessions()">Refresh</button>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h2>All Sessions</h2>
            <span class="badge" id="sessions-total">0</span>
        </div>
        <div class="card-body">
            <div id="sessions-list" class="table-container">
                <p class="loading">Loading sessions...</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –∫–æ–¥–∞ -->
<div id="parse-code-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üîç –ü–∞—Ä—Å–∏–Ω–≥ –∫–æ–¥–∞ –∏–∑ Telegram</h2>
            <button class="modal-close" onclick="closeParseCodeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="parse-code-status"></div>
            <div id="parse-code-result" style="display: none;">
                <div class="code-display">
                    <span id="parsed-code-value"></span>
                </div>
                <button class="btn btn-primary btn-copy" onclick="copyCode()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                <p id="code-message" class="code-info"></p>
            </div>
        </div>
    </div>
</div>

<!-- Modal –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–¥–∞ -->
<div id="get-code-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üì± –ü–æ–ª—É—á–∏—Ç—å Telegram Session</h2>
            <button class="modal-close" onclick="closeGetCodeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="get-code-status"></div>
            <form id="get-code-form" onsubmit="startGetCode(event)" style="display: block;">
                <div class="form-group">
                    <label>–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
                    <input type="text" name="phone_number" required placeholder="+79001234567" pattern="^\+[0-9]{10,15}$">
                    <small>–§–æ—Ä–º–∞—Ç: +79001234567 (—Å –∫–æ–¥–æ–º —Å—Ç—Ä–∞–Ω—ã)</small>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeGetCodeModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="button" class="btn btn-secondary" onclick="showDirectCodeInput()">–£ –º–µ–Ω—è —É–∂–µ –µ—Å—Ç—å –∫–æ–¥</button>
                    <button type="submit" class="btn btn-primary">–ó–∞–ø—Ä–æ—Å–∏—Ç—å –Ω–æ–≤—ã–π –∫–æ–¥</button>
                </div>
            </form>
            
            <div id="direct-code-section" style="display: none;">
                <div class="form-group">
                    <label>–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
                    <input type="text" id="direct-phone" placeholder="+79001234567" readonly>
                    <small>–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –≤—ã –ø–æ–ª—É—á–∏–ª–∏ –≤ Telegram</small>
                </div>
                <div class="form-group">
                    <label>–ö–æ–¥ –∏–∑ Telegram</label>
                    <input type="text" id="direct-code" placeholder="12345" maxlength="10">
                    <small>–ö–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –≤—ã —É–∂–µ –ø–æ–ª—É—á–∏–ª–∏ –≤ Telegram</small>
                </div>
                <div class="form-group" id="direct-password-section" style="display: none;">
                    <label>–ü–∞—Ä–æ–ª—å 2FA (–µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)</label>
                    <input type="password" id="direct-password" placeholder="–ü–∞—Ä–æ–ª—å">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="cancelDirectCode()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="button" class="btn btn-primary" onclick="submitDirectCode()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∫–æ–¥</button>
                </div>
            </div>
            
            <div id="code-input-section" style="display: none;">
                <div class="form-group">
                    <label>–ö–æ–¥ –∏–∑ Telegram</label>
                    <input type="text" id="telegram-code" placeholder="12345" maxlength="10">
                    <small>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ Telegram - –∫–æ–¥ –¥–æ–ª–∂–µ–Ω –ø—Ä–∏–π—Ç–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ –º–∏–Ω—É—Ç—ã</small>
                </div>
                <div class="form-group" id="password-section" style="display: none;">
                    <label>–ü–∞—Ä–æ–ª—å 2FA (–µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)</label>
                    <input type="password" id="telegram-password" placeholder="–ü–∞—Ä–æ–ª—å">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="cancelGetCode()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="button" class="btn btn-primary" onclick="submitCode()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    async function loadSessions() {
        try {
            const res = await fetch('/api/v1/sessions');
            const data = await res.json();
            
            document.getElementById('sessions-total').textContent = data.total;
            displaySessions(data.sessions);
        } catch (error) {
            console.error('Error loading sessions:', error);
            document.getElementById('sessions-list').innerHTML = 
                '<p class="error">Error loading sessions</p>';
        }
    }
    
    function displaySessions(sessions) {
        const container = document.getElementById('sessions-list');
        
        if (sessions.length === 0) {
            container.innerHTML = '<p class="empty">No sessions found</p>';
            return;
        }
        
        container.innerHTML = `
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Phone</th>
                        <th>Filename</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${sessions.map(s => `
                        <tr>
                            <td>${s.phone}</td>
                            <td><code>${s.filename}</code></td>
                            <td><span class="badge badge-success">Active</span></td>
                            <td>${s.created_at || 'Unknown'}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="parseCodeFromSession('${s.phone}')" title="–ü–∞—Ä—Å–∏—Ç—å –∫–æ–¥ –∏–∑ Telegram">üîç –ü–∞—Ä—Å–∏—Ç—å –∫–æ–¥</button>
                                ${s.twoFA ? `<button class="btn btn-sm btn-2fa" onclick="copy2FA('${s.twoFA}')" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å 2FA –ø–∞—Ä–æ–ª—å">üîê 2FA</button>` : ''}
                                <button class="btn btn-sm btn-secondary" onclick="getCodeForPhone('${s.phone}')" title="–ü–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–π –∫–æ–¥">üì± –ù–æ–≤—ã–π</button>
                                <button class="btn btn-sm" onclick="testSession('${s.phone}')">Test</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    }
    
    function refreshSessions() {
        document.getElementById('sessions-list').innerHTML = '<p class="loading">Refreshing...</p>';
        loadSessions();
    }
    
    function testSession(phone) {
        alert(`Testing session for ${phone}`);
        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    }
    
    let currentGetCodeRequest = null;
    
    function showGetCodeModal(phoneNumber = '') {
        document.getElementById('get-code-modal').style.display = 'block';
        document.getElementById('get-code-form').style.display = 'block';
        document.getElementById('code-input-section').style.display = 'none';
        document.getElementById('direct-code-section').style.display = 'none';
        document.getElementById('get-code-status').innerHTML = '';
        
        // –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω –Ω–æ–º–µ—Ä, –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å –µ–≥–æ
        if (phoneNumber) {
            document.querySelector('input[name="phone_number"]').value = phoneNumber;
            document.getElementById('direct-phone').value = phoneNumber;
        }
    }
    
    function showDirectCodeInput() {
        const phoneInput = document.querySelector('input[name="phone_number"]');
        const phone = phoneInput.value;
        
        if (!phone) {
            alert('–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞');
            return;
        }
        
        document.getElementById('get-code-form').style.display = 'none';
        document.getElementById('direct-code-section').style.display = 'block';
        document.getElementById('direct-phone').value = phone;
        document.getElementById('direct-code').value = '';
        document.getElementById('direct-code').focus();
        document.getElementById('get-code-status').innerHTML = 
            '<div class="badge badge-info">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –≤—ã —É–∂–µ –ø–æ–ª—É—á–∏–ª–∏ –≤ Telegram</div>';
    }
    
    function cancelDirectCode() {
        document.getElementById('direct-code-section').style.display = 'none';
        document.getElementById('get-code-form').style.display = 'block';
        document.getElementById('get-code-status').innerHTML = '';
    }
    
    async function submitDirectCode() {
        const phone = document.getElementById('direct-phone').value;
        const code = document.getElementById('direct-code').value;
        const password = document.getElementById('direct-password').value;
        
        if (!phone || !code) {
            alert('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏ –∫–æ–¥');
            return;
        }
        
        document.getElementById('get-code-status').innerHTML = 
            '<div class="loading">–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞...</div>';
        
        try {
            const res = await fetch('/api/v1/sessions/verify-code-direct', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    phone_number: phone,
                    code: code,
                    password: password || null
                })
            });
            
            const data = await res.json();
            
            if (res.ok && data.status === 'success') {
                document.getElementById('get-code-status').innerHTML = 
                    '<div class="badge badge-success">Session –ø–æ–ª—É—á–µ–Ω! –§–∞–π–ª: ' + data.filename + '</div>';
                setTimeout(() => {
                    closeGetCodeModal();
                    refreshSessions();
                }, 2000);
            } else if (data.status === 'need_password') {
                document.getElementById('direct-password-section').style.display = 'block';
                document.getElementById('get-code-status').innerHTML = 
                    '<div class="badge badge-warning">–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Ä–æ–ª—å 2FA</div>';
            } else {
                document.getElementById('get-code-status').innerHTML = 
                    '<div class="error">–û—à–∏–±–∫–∞: ' + (data.detail || '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥. –í–æ–∑–º–æ–∂–Ω–æ –Ω—É–∂–µ–Ω –Ω–æ–≤—ã–π –∫–æ–¥ —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É.') + '</div>';
            }
        } catch (error) {
            document.getElementById('get-code-status').innerHTML = 
                '<div class="error">–û—à–∏–±–∫–∞: ' + error.message + '</div>';
        }
    }
    
    function getCodeForPhone(phone) {
        showGetCodeModal(phone);
    }
    
    function closeGetCodeModal() {
        document.getElementById('get-code-modal').style.display = 'none';
        if (currentGetCodeRequest) {
            // –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –µ—Å–ª–∏ –µ—Å—Ç—å
        }
    }
    
    async function startGetCode(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        const phone = formData.get('phone_number');
        
        document.getElementById('get-code-status').innerHTML = 
            '<div class="loading">–ó–∞–ø—Ä–æ—Å –∫–æ–¥–∞ –≤ Telegram –¥–ª—è ' + phone + '...<br>–ö–æ–¥ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram –Ω–∞ —ç—Ç–æ—Ç –Ω–æ–º–µ—Ä</div>';
        
        try {
            const res = await fetch('/api/v1/sessions/get-code', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({phone_number: phone})
            });
            
            const data = await res.json();
            
            if (res.ok && data.status === 'code_sent') {
                document.getElementById('get-code-form').style.display = 'none';
                document.getElementById('code-input-section').style.display = 'block';
                document.getElementById('get-code-status').innerHTML = 
                    '<div class="badge badge-success">–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ ' + phone + '!<br>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ Telegram - –∫–æ–¥ –¥–æ–ª–∂–µ–Ω –ø—Ä–∏–π—Ç–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ –º–∏–Ω—É—Ç—ã. –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –Ω–∏–∂–µ.</div>';
                currentGetCodeRequest = {phone: phone, phone_code_hash: data.phone_code_hash};
                // –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ –∫–æ–¥–∞
                document.getElementById('telegram-code').value = '';
                document.getElementById('telegram-code').focus();
                
                // –ù–∞—á–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∫–æ–¥–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã)
                startAutoCodeCheck(phone);
            } else if (data.status === 'session_exists' || data.status === 'already_authorized') {
                document.getElementById('get-code-status').innerHTML = 
                    '<div class="badge badge-warning">–ê–∫–∫–∞—É–Ω—Ç —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω. Session –Ω–∞–π–¥–µ–Ω: ' + (data.session_file || '—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π session') + '</div>';
                setTimeout(() => {
                    closeGetCodeModal();
                    refreshSessions();
                }, 2000);
            } else {
                document.getElementById('get-code-status').innerHTML = 
                    '<div class="error">–û—à–∏–±–∫–∞: ' + (data.detail || data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</div>';
            }
        } catch (error) {
            document.getElementById('get-code-status').innerHTML = 
                '<div class="error">‚ùå –û—à–∏–±–∫–∞: ' + error.message + '</div>';
        }
    }
    
    async function submitCode() {
        const code = document.getElementById('telegram-code').value;
        const password = document.getElementById('telegram-password').value;
        
        if (!code) {
            alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ Telegram');
            return;
        }
        
        document.getElementById('get-code-status').innerHTML = 
            '<div class="loading">‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞...</div>';
        
        try {
            const res = await fetch('/api/v1/sessions/verify-code', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    phone_number: currentGetCodeRequest.phone,
                    phone_code_hash: currentGetCodeRequest.phone_code_hash,
                    code: code,
                    password: password || null
                })
            });
            
            const data = await res.json();
            
            if (res.ok && data.status === 'success') {
                document.getElementById('get-code-status').innerHTML = 
                    '<div class="badge badge-success">‚úÖ Session –ø–æ–ª—É—á–µ–Ω! –§–∞–π–ª: ' + data.filename + '</div>';
                setTimeout(() => {
                    closeGetCodeModal();
                    refreshSessions();
                }, 2000);
            } else if (data.need_password) {
                document.getElementById('password-section').style.display = 'block';
                document.getElementById('get-code-status').innerHTML = 
                    '<div class="badge badge-warning">üîí –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Ä–æ–ª—å 2FA</div>';
            } else {
                document.getElementById('get-code-status').innerHTML = 
                    '<div class="error">‚ùå –û—à–∏–±–∫–∞: ' + (data.detail || '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥') + '</div>';
            }
        } catch (error) {
            document.getElementById('get-code-status').innerHTML = 
                '<div class="error">‚ùå –û—à–∏–±–∫–∞: ' + error.message + '</div>';
        }
    }
    
    function cancelGetCode() {
        closeGetCodeModal();
        currentGetCodeRequest = null;
        if (autoCodeCheckInterval) {
            clearInterval(autoCodeCheckInterval);
            autoCodeCheckInterval = null;
        }
    }
    
    let autoCodeCheckInterval = null;
    
    async function startAutoCodeCheck(phone) {
        // –ü—Ä–æ–≤–µ—Ä—è—Ç—å –∫–æ–¥ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
        let attempts = 0;
        const maxAttempts = 35; // 70 —Å–µ–∫—É–Ω–¥ –º–∞–∫—Å–∏–º—É–º (–∫–æ–¥ –º–æ–∂–µ—Ç –ø—Ä–∏–π—Ç–∏ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π)
        
        autoCodeCheckInterval = setInterval(async () => {
            attempts++;
            
            if (attempts > maxAttempts) {
                clearInterval(autoCodeCheckInterval);
                autoCodeCheckInterval = null;
                document.getElementById('get-code-status').innerHTML = 
                    '<div class="badge badge-warning">–ö–æ–¥ –Ω–µ –ø–æ–ª—É—á–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –≤—Ä—É—á–Ω—É—é.</div>';
                return;
            }
            
            try {
                // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—É—á–µ–Ω –ª–∏ –∫–æ–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                const res = await fetch(`/api/v1/sessions/check-code/${encodeURIComponent(phone)}`);
                const data = await res.json();
                
                if (data.status === 'code_found' && data.code) {
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å –∫–æ–¥
                    document.getElementById('telegram-code').value = data.code;
                    document.getElementById('get-code-status').innerHTML = 
                        '<div class="badge badge-success">–ö–æ–¥ –ø–æ–ª—É—á–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏! –ü—Ä–æ–≤–µ—Ä–∫–∞...</div>';
                    clearInterval(autoCodeCheckInterval);
                    autoCodeCheckInterval = null;
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å
                    setTimeout(() => submitCode(), 500);
                } else if (data.status === 'session_created') {
                    // Session —É–∂–µ —Å–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                    document.getElementById('get-code-status').innerHTML = 
                        '<div class="badge badge-success">Session —Å–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏! –§–∞–π–ª: ' + (data.filename || '—Å–æ–∑–¥–∞–Ω') + '</div>';
                    clearInterval(autoCodeCheckInterval);
                    autoCodeCheckInterval = null;
                    setTimeout(() => {
                        closeGetCodeModal();
                        refreshSessions();
                    }, 2000);
                }
            } catch (error) {
                // –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏
            }
        }, 2000);
    }
    
    // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ—ë
    window.onclick = function(event) {
        const modal = document.getElementById('get-code-modal');
        if (event.target == modal) {
            closeGetCodeModal();
        }
    }
    
    // ===== –ü–∞—Ä—Å–∏–Ω–≥ –∫–æ–¥–∞ –∏–∑ Telegram =====
    
    function showParseCodeModal(phone) {
        document.getElementById('parse-code-modal').style.display = 'block';
        document.getElementById('parse-code-status').innerHTML = '<div class="loading">–ü–∞—Ä—Å–∏–Ω–≥ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ Telegram...</div>';
        document.getElementById('parse-code-result').style.display = 'none';
    }
    
    function closeParseCodeModal() {
        document.getElementById('parse-code-modal').style.display = 'none';
    }
    
    async function parseCodeFromSession(phone) {
        showParseCodeModal(phone);
        
        try {
            const res = await fetch('/api/v1/sessions/parse-code', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({phone_number: phone})
            });
            
            const data = await res.json();
            console.log('Parse response:', data);
            
            if (res.ok && data.status === 'found') {
                document.getElementById('parse-code-status').innerHTML = '';
                document.getElementById('parse-code-result').style.display = 'block';
                document.getElementById('parsed-code-value').textContent = data.code;
                
                // –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –∫–æ–¥—ã
                let codesHtml = '<p class="code-info">' + data.message + '</p>';
                if (data.all_codes && data.all_codes.length > 1) {
                    codesHtml += '<p style="margin-top:10px"><b>–í—Å–µ –∫–æ–¥—ã:</b></p><ul style="text-align:left">';
                    data.all_codes.forEach(c => {
                        codesHtml += '<li><b>' + c.code + '</b> (' + (c.hours_ago || 0) + ' —á. –Ω–∞–∑–∞–¥)</li>';
                    });
                    codesHtml += '</ul>';
                }
                document.getElementById('code-message').innerHTML = codesHtml;
            } else if (data.status === 'not_found') {
                // –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                let html = '<div class="badge badge-warning">–ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω</div>';
                if (data.all_messages && data.all_messages.length > 0) {
                    html += '<p style="margin-top:15px"><b>–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç Telegram:</b></p>';
                    html += '<div style="text-align:left; max-height:200px; overflow-y:auto; font-size:12px; background:#f5f5f5; padding:10px; border-radius:5px">';
                    data.all_messages.forEach((m, i) => {
                        html += '<div style="margin-bottom:8px; padding-bottom:8px; border-bottom:1px solid #ddd">';
                        html += '<small style="color:#888">' + (m.seconds_ago ? Math.round(m.seconds_ago/60) + ' –º–∏–Ω. –Ω–∞–∑–∞–¥' : '') + '</small><br>';
                        html += m.text;
                        html += '</div>';
                    });
                    html += '</div>';
                }
                document.getElementById('parse-code-status').innerHTML = html;
                document.getElementById('parse-code-result').style.display = 'none';
            } else {
                document.getElementById('parse-code-status').innerHTML = 
                    '<div class="error">–û—à–∏–±–∫–∞: ' + (data.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</div>';
            }
        } catch (error) {
            document.getElementById('parse-code-status').innerHTML = 
                '<div class="error">–û—à–∏–±–∫–∞: ' + error.message + '</div>';
        }
    }
    
    function copyCode() {
        const code = document.getElementById('parsed-code-value').textContent;
        navigator.clipboard.writeText(code).then(() => {
            const btn = document.querySelector('.btn-copy');
            btn.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
            setTimeout(() => {
                btn.textContent = 'üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
            }, 2000);
        }).catch(err => {
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å: ' + err);
        });
    }
    
    function copy2FA(password) {
        navigator.clipboard.writeText(password).then(() => {
            // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            const notification = document.createElement('div');
            notification.className = 'copy-notification';
            notification.textContent = '‚úÖ 2FA —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω: ' + password;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.remove();
            }, 2000);
        }).catch(err => {
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å: ' + err);
        });
    }
    
    // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É –ø–∞—Ä—Å–∏–Ω–≥–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ—ë
    window.addEventListener('click', function(event) {
        const parseModal = document.getElementById('parse-code-modal');
        if (event.target == parseModal) {
            closeParseCodeModal();
        }
    });
    
    // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    loadSessions();
</script>
{% endblock %}

