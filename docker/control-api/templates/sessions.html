{% extends "base.html" %}

{% block title %}Sessions - Telegram Farm{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1 class="page-title">Sessions</h1>
        <div>
            <button class="btn btn-primary" onclick="showGetCodeModal()">üì± –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥</button>
            <button class="btn btn-success" onclick="checkAllRestrictions()">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ —Å—Ç–∞—Ç—É—Å—ã</button>
            <button class="btn btn-secondary" onclick="refreshSessions()">Refresh</button>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h2>All Sessions</h2>
            <span class="badge" id="sessions-total">0</span>
        </div>
        <div class="card-body">
            <div id="sessions-list" class="table-container">
                <p class="loading">Loading sessions...</p>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª–∫–∞ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–æ–≤ -->
    <div id="restrictions-modal" class="modal">
        <div class="modal-content" style="max-width: 90%; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>üîç –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–æ–≤</h2>
                <button class="modal-close" onclick="closeRestrictionsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="restrictions-status"></div>
                <div id="restrictions-results"></div>
            </div>
        </div>
    </div>
</div>

<!-- Modal –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –∫–æ–¥–∞ -->
<div id="parse-code-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üîç –ü–∞—Ä—Å–∏–Ω–≥ –∫–æ–¥–∞ –∏–∑ Telegram</h2>
            <button class="modal-close" onclick="closeParseCodeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="parse-code-status"></div>
            <div id="parse-code-result" style="display: none;">
                <div class="code-display">
                    <span id="parsed-code-value"></span>
                </div>
                <button class="btn btn-primary btn-copy" onclick="copyCode()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                <p id="code-message" class="code-info"></p>
            </div>
        </div>
    </div>
</div>

<!-- Modal –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–¥–∞ -->
<div id="get-code-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üì± –ü–æ–ª—É—á–∏—Ç—å Telegram Session</h2>
            <button class="modal-close" onclick="closeGetCodeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="get-code-status"></div>
            <form id="get-code-form" onsubmit="startGetCode(event)" style="display: block;">
                <div class="form-group">
                    <label>–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
                    <input type="text" name="phone_number" required placeholder="+79001234567" pattern="^\+[0-9]{10,15}$">
                    <small>–§–æ—Ä–º–∞—Ç: +79001234567 (—Å –∫–æ–¥–æ–º —Å—Ç—Ä–∞–Ω—ã)</small>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeGetCodeModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="button" class="btn btn-secondary" onclick="showDirectCodeInput()">–£ –º–µ–Ω—è —É–∂–µ –µ—Å—Ç—å –∫–æ–¥</button>
                    <button type="submit" class="btn btn-primary">–ó–∞–ø—Ä–æ—Å–∏—Ç—å –Ω–æ–≤—ã–π –∫–æ–¥</button>
                </div>
            </form>
            
            <div id="direct-code-section" style="display: none;">
                <div class="form-group">
                    <label>–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
                    <input type="text" id="direct-phone" placeholder="+79001234567" readonly>
                    <small>–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –≤—ã –ø–æ–ª—É—á–∏–ª–∏ –≤ Telegram</small>
                </div>
                <div class="form-group">
                    <label>–ö–æ–¥ –∏–∑ Telegram</label>
                    <input type="text" id="direct-code" placeholder="12345" maxlength="10">
                    <small>–ö–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –≤—ã —É–∂–µ –ø–æ–ª—É—á–∏–ª–∏ –≤ Telegram</small>
                </div>
                <div class="form-group" id="direct-password-section" style="display: none;">
                    <label>–ü–∞—Ä–æ–ª—å 2FA (–µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)</label>
                    <input type="password" id="direct-password" placeholder="–ü–∞—Ä–æ–ª—å">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="cancelDirectCode()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="button" class="btn btn-primary" onclick="submitDirectCode()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∫–æ–¥</button>
                </div>
            </div>
            
            <div id="code-input-section" style="display: none;">
                <div class="form-group">
                    <label>–ö–æ–¥ –∏–∑ Telegram</label>
                    <input type="text" id="telegram-code" placeholder="12345" maxlength="10">
                    <small>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ Telegram - –∫–æ–¥ –¥–æ–ª–∂–µ–Ω –ø—Ä–∏–π—Ç–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ –º–∏–Ω—É—Ç—ã</small>
                </div>
                <div class="form-group" id="password-section" style="display: none;">
                    <label>–ü–∞—Ä–æ–ª—å 2FA (–µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)</label>
                    <input type="password" id="telegram-password" placeholder="–ü–∞—Ä–æ–ª—å">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="cancelGetCode()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="button" class="btn btn-primary" onclick="submitCode()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ========== FETCH –° –¢–ê–ô–ú–ê–£–¢–û–ú (—á—Ç–æ–±—ã –Ω–µ –∑–∞–≤–∏—Å–∞–ª–æ) ==========
    async function fetchWithTimeout(url, options = {}, timeout = 10000) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeout);
        
        try {
            const response = await fetch(url, {
                ...options,
                signal: controller.signal
            });
            clearTimeout(timeoutId);
            return response;
        } catch (error) {
            clearTimeout(timeoutId);
            if (error.name === 'AbortError') {
                throw new Error(`–¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ (${timeout}–º—Å): ${url}`);
            }
            throw error;
        }
    }
    
    let sessionsData = []; // –•—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–π —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏
    
    async function loadSessions() {
        try {
            const res = await fetchWithTimeout('/api/v1/sessions', {}, 8000);
            const data = await res.json();
            
            document.getElementById('sessions-total').textContent = data.total;
            
            // –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–π —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º–∏ —Å—Ç–∞—Ç—É—Å–∞–º–∏
            sessionsData = data.sessions.map(s => ({
                ...s,
                restriction_status: s.restriction_status || null,
                restriction_details: s.restriction_details || null,
                restriction_checked_at: s.restriction_checked_at || null,
                total_activity_seconds: parseFloat(s.total_activity_seconds || 0)
            }));
            
            // –°–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã
            displaySessions(sessionsData);
            
            // –ó–∞—Ç–µ–º –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã –¥–ª—è —Ç–µ—Ö, —É –∫–æ–≥–æ –∏—Ö –Ω–µ—Ç –∏–ª–∏ –æ–Ω–∏ —É—Å—Ç–∞—Ä–µ–ª–∏ (—Å—Ç–∞—Ä—à–µ 24 —á–∞—Å–æ–≤)
            await updateStaleStatuses(sessionsData);
        } catch (error) {
            console.error('Error loading sessions:', error);
            document.getElementById('sessions-list').innerHTML = 
                '<p class="error">Error loading sessions</p>';
        }
    }
    
    async function updateStaleStatuses(sessions) {
        const now = new Date();
        const oneDayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
        
        // –ù–∞–π—Ç–∏ —Å–µ—Å—Å–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å
        const sessionsToUpdate = sessions.filter(s => {
            // –û–±–Ω–æ–≤–∏—Ç—å –µ—Å–ª–∏ –Ω–µ—Ç —Å—Ç–∞—Ç—É—Å–∞ –∏–ª–∏ –æ–Ω —É—Å—Ç–∞—Ä–µ–ª
            if (!s.restriction_status || !s.restriction_checked_at) {
                return true;
            }
            const checkedAt = new Date(s.restriction_checked_at);
            return checkedAt < oneDayAgo;
        });
        
        if (sessionsToUpdate.length === 0) {
            return; // –í—Å–µ —Å—Ç–∞—Ç—É—Å—ã –∞–∫—Ç—É–∞–ª—å–Ω—ã
        }
        
        // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã –¥–ª—è –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏–π
        const statusPromises = sessionsToUpdate.map(async (s) => {
            try {
                const res = await fetchWithTimeout('/api/v1/sessions/check-restrictions', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ phone: s.phone })
                }, 15000);
                
                const data = await res.json();
                return { ...s, restriction_status: data.status || 'unknown', restriction_details: data };
            } catch (error) {
                return { ...s, restriction_status: 'error', restriction_details: { 
                    error: error.message,
                    can_send_messages: false,
                    can_create_groups: false
                }};
            }
        });
        
        const updatedSessions = await Promise.all(statusPromises);
        
        // –û–±–Ω–æ–≤–∏—Ç—å sessionsData —Å –Ω–æ–≤—ã–º–∏ —Å—Ç–∞—Ç—É—Å–∞–º–∏
        updatedSessions.forEach(updated => {
            const index = sessionsData.findIndex(s => s.phone === updated.phone);
            if (index !== -1) {
                sessionsData[index] = updated;
            }
        });
        
        // –û–±–Ω–æ–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        displaySessions(sessionsData);
    }
    
    function getTotalActivityTime(totalSeconds) {
        if (!totalSeconds || totalSeconds === 0) {
            return '<span style="color: #999;">0—á 0–º 0—Å</span>';
        }
        
        try {
            const total = parseFloat(totalSeconds);
            const hours = Math.floor(total / 3600);
            const minutes = Math.floor((total % 3600) / 60);
            const seconds = Math.floor(total % 60);
            
            // –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤—Å–µ –µ–¥–∏–Ω–∏—Ü—ã –≤—Ä–µ–º–µ–Ω–∏
            let timeStr = '';
            if (hours > 0) {
                timeStr += `${hours}—á `;
            }
            if (minutes > 0 || hours > 0) {
                timeStr += `${minutes}–º `;
            }
            timeStr += `${seconds}—Å`;
            
            // –¶–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—Ä–µ–º–µ–Ω–∏
            let color = '#999';
            if (hours > 0) {
                color = '#28a745';
            } else if (minutes > 0) {
                color = '#ffc107';
            }
            
            return `<span style="color: ${color}; font-weight: ${hours > 0 ? 'bold' : 'normal'};">${timeStr.trim()}</span>`;
        } catch (e) {
            return '<span style="color: #999;">–û—à–∏–±–∫–∞</span>';
        }
    }
    
    function updateActivityTimers() {
        // –û–±–Ω–æ–≤–∏—Ç—å —Ç–∞–π–º–µ—Ä—ã - –ø–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –∏–∑ sessionsData
        const activityCells = document.querySelectorAll('td[data-activity-seconds]');
        activityCells.forEach(cell => {
            const phone = cell.getAttribute('data-session-phone');
            if (phone) {
                // –ü–æ–ª—É—á–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –∏–∑ sessionsData
                const session = sessionsData.find(s => s.phone === phone);
                if (session) {
                    let totalSeconds = parseFloat(session.total_activity_seconds || 0);
                    // –ï—Å–ª–∏ –∞–∫–∫–∞—É–Ω—Ç —Å–µ–π—á–∞—Å –∞–∫—Ç–∏–≤–µ–Ω, –¥–æ–±–∞–≤–∏—Ç—å –≤—Ä–µ–º—è —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏
                    // (—ç—Ç–æ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã)
                    cell.innerHTML = getTotalActivityTime(totalSeconds);
                }
            }
        });
    }
    
    let activityTimerInterval = null;
    
    function startActivityTimers() {
        // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –µ—Å–ª–∏ –µ—Å—Ç—å
        if (activityTimerInterval) {
            clearInterval(activityTimerInterval);
        }
        
        // –û–±–Ω–æ–≤–ª—è—Ç—å —Ç–∞–π–º–µ—Ä—ã –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
        activityTimerInterval = setInterval(updateActivityTimers, 1000);
    }
    
    function getStatusBadge(status, restrictionStatus) {
        // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –µ—â–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è
        if (!restrictionStatus || restrictionStatus === 'checking') {
            return '<span class="badge badge-secondary">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>';
        }
        
        // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω
        if (restrictionStatus === 'unknown') {
            return '<span class="badge badge-secondary" style="cursor: pointer;" onclick="showStatusDetails(this)" title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π">‚ùì Unknown</span>';
        }
        
        let badgeClass = 'badge-secondary';
        let badgeText = 'Unknown';
        let badgeIcon = '‚ùì';
        
        if (restrictionStatus === 'ok') {
            badgeClass = 'badge-success';
            badgeText = 'OK';
            badgeIcon = '‚úÖ';
        } else if (restrictionStatus === 'shadow_ban') {
            badgeClass = 'badge-warning';
            badgeText = 'Shadow Ban';
            badgeIcon = 'üåë';
        } else if (restrictionStatus === 'flood_limit') {
            badgeClass = 'badge-danger';
            badgeText = 'Flood Limit';
            badgeIcon = '‚ùÑÔ∏è';
        } else if (restrictionStatus === 'restricted') {
            badgeClass = 'badge-secondary';
            badgeText = 'Restricted';
            badgeIcon = 'üö´';
        } else if (restrictionStatus === 'error') {
            badgeClass = 'badge-secondary';
            badgeText = 'Error';
            badgeIcon = '‚ö†Ô∏è';
        } else if (restrictionStatus === 'no_session') {
            badgeClass = 'badge-warning';
            badgeText = 'No Session';
            badgeIcon = 'üì±';
            return `<span class="badge ${badgeClass}">${badgeIcon} ${badgeText}</span>`;
        }
        
        return `<span class="badge ${badgeClass}" style="cursor: pointer;" onclick="showStatusDetails(this)" title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π">${badgeIcon} ${badgeText}</span>`;
    }
    
    function displaySessions(sessions) {
        const container = document.getElementById('sessions-list');
        
        if (sessions.length === 0) {
            container.innerHTML = '<p class="empty">No sessions found</p>';
            return;
        }
        
        container.innerHTML = `
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Phone</th>
                        <th>Filename</th>
                        <th>Status</th>
                        <th>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${sessions.map((s, index) => `
                        <tr>
                            <td>${s.phone}</td>
                            <td><code>${s.filename}</code></td>
                            <td data-session-index="${index}">
                                ${getStatusBadge(s.restriction_status || s.status, s.restriction_status)}
                            </td>
                            <td data-activity-seconds="${s.total_activity_seconds || 0}" data-session-phone="${s.phone}">
                                ${getTotalActivityTime(s.total_activity_seconds || 0)}
                            </td>
                            <td>${s.created_at || 'Unknown'}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="parseCodeFromSession('${s.phone}')" title="–ü–∞—Ä—Å–∏—Ç—å –∫–æ–¥ –∏–∑ Telegram">üîç –ü–∞—Ä—Å–∏—Ç—å –∫–æ–¥</button>
                                ${s.twoFA ? `<button class="btn btn-sm btn-2fa" data-2fa="${String(s.twoFA).replace(/"/g, '&quot;')}" onclick="copy2FA(this)" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å 2FA –ø–∞—Ä–æ–ª—å">üîê 2FA</button>` : ''}
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        
        // –ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–æ–≤ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        startActivityTimers();
    }
    
    function showStatusDetails(element) {
        const row = element.closest('tr');
        const index = parseInt(row.querySelector('td[data-session-index]').getAttribute('data-session-index'));
        const session = sessionsData[index];
        
        if (!session) {
            alert('–î–µ—Ç–∞–ª–∏ —Å—Ç–∞—Ç—É—Å–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã');
            return;
        }
        
        const details = session.restriction_details || {};
        const status = session.restriction_status || 'unknown';
        
        // –ï—Å–ª–∏ –¥–µ—Ç–∞–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã, –Ω–æ –µ—Å—Ç—å —Å—Ç–∞—Ç—É—Å
        if (!details || Object.keys(details).length === 0) {
            let html = `
                <div style="padding: 20px;">
                    <h3>üìä –°—Ç–∞—Ç—É—Å –∞–∫–∫–∞—É–Ω—Ç–∞: ${session.phone}</h3>
                    <div style="margin-top: 15px;">
                        <div class="badge badge-secondary">–°—Ç–∞—Ç—É—Å: ${status}</div>
                        <p style="margin-top: 15px; color: #666;">–î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ —Å—Ç–∞—Ç—É—Å—ã".</p>
                    </div>
                </div>
            `;
            document.getElementById('restrictions-status').innerHTML = html;
            document.getElementById('restrictions-results').innerHTML = '';
            showRestrictionsModal();
            return;
        }
        let html = `
            <div style="padding: 20px;">
                <h3>üìä –°—Ç–∞—Ç—É—Å –∞–∫–∫–∞—É–Ω—Ç–∞: ${session.phone}</h3>
                <div style="margin-top: 15px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div style="padding: 15px; background: ${details.can_send_messages ? '#d4edda' : '#f8d7da'}; border-radius: 5px; border: 1px solid ${details.can_send_messages ? '#c3e6cb' : '#f5c6cb'};">
                            <div style="font-size: 18px; font-weight: bold; margin-bottom: 5px;">
                                ${details.can_send_messages ? '‚úÖ' : '‚ùå'} –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
                            </div>
                            <div style="color: #666;">
                                ${details.can_send_messages ? '–ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è' : '–ù–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è'}
                            </div>
                        </div>
                        <div style="padding: 15px; background: ${details.can_create_groups ? '#d4edda' : '#f8d7da'}; border-radius: 5px; border: 1px solid ${details.can_create_groups ? '#c3e6cb' : '#f5c6cb'};">
                            <div style="font-size: 18px; font-weight: bold; margin-bottom: 5px;">
                                ${details.can_create_groups ? '‚úÖ' : '‚ùå'} –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø
                            </div>
                            <div style="color: #666;">
                                ${details.can_create_groups ? '–ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –≥—Ä—É–ø–ø—ã' : '–ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞–≤–∞—Ç—å –≥—Ä—É–ø–ø—ã'}
                            </div>
                        </div>
                    </div>
        `;
        
        if (details.details) {
            html += '<div style="margin-top: 15px;"><strong>–î–µ—Ç–∞–ª–∏:</strong><ul style="text-align: left; margin-top: 10px;">';
            for (const [key, value] of Object.entries(details.details)) {
                if (value) {
                    html += `<li><strong>${key}:</strong> ${value}</li>`;
                }
            }
            html += '</ul></div>';
        }
        
        if (details.flood_wait_until) {
            const waitUntil = new Date(details.flood_wait_until * 1000);
            const now = new Date();
            const waitSeconds = Math.max(0, Math.floor((waitUntil - now) / 1000));
            html += `<div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 5px;">
                <strong>‚è±Ô∏è Flood wait:</strong> –û–∂–∏–¥–∞–Ω–∏–µ –¥–æ ${waitUntil.toLocaleString()} (${waitSeconds} —Å–µ–∫.)
            </div>`;
        }
        
        html += '</div>';
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
        document.getElementById('restrictions-status').innerHTML = html;
        document.getElementById('restrictions-results').innerHTML = '';
        showRestrictionsModal();
    }
    
    function refreshSessions() {
        document.getElementById('sessions-list').innerHTML = '<p class="loading">Refreshing...</p>';
        loadSessions();
    }
    
    
    // ===== –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π =====
    
    function showRestrictionsModal() {
        document.getElementById('restrictions-modal').style.display = 'block';
    }
    
    function closeRestrictionsModal() {
        document.getElementById('restrictions-modal').style.display = 'none';
    }
    
    async function checkAllRestrictions() {
        showRestrictionsModal();
        document.getElementById('restrictions-status').innerHTML = 
            '<div class="loading">‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤... –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è.</div>';
        document.getElementById('restrictions-results').innerHTML = '';
        
        try {
            const res = await fetchWithTimeout('/api/v1/sessions/check-all-restrictions', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            }, 300000); // 5 –º–∏–Ω—É—Ç —Ç–∞–π–º–∞—É—Ç –¥–ª—è –º–∞—Å—Å–æ–≤–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
            
            const data = await res.json();
            
            if (res.ok && data.status === 'success') {
                // –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                const stats = data.statistics || {};
                let statsHtml = `
                    <div style="margin-bottom: 20px; padding: 15px; background: #f5f5f5; border-radius: 5px;">
                        <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 10px;">
                            <div style="text-align: center; padding: 10px; background: white; border-radius: 5px;">
                                <div style="font-size: 24px; font-weight: bold; color: #28a745;">${stats.ok || 0}</div>
                                <div style="color: #666;">‚úÖ OK</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: white; border-radius: 5px;">
                                <div style="font-size: 24px; font-weight: bold; color: #ffc107;">${stats.shadow_ban || 0}</div>
                                <div style="color: #666;">üåë Shadow Ban</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: white; border-radius: 5px;">
                                <div style="font-size: 24px; font-weight: bold; color: #dc3545;">${stats.flood_limit || 0}</div>
                                <div style="color: #666;">‚ùÑÔ∏è Flood Limit</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: white; border-radius: 5px;">
                                <div style="font-size: 24px; font-weight: bold; color: #6c757d;">${stats.restricted || 0}</div>
                                <div style="color: #666;">üö´ Restricted</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: white; border-radius: 5px;">
                                <div style="font-size: 24px; font-weight: bold; color: #6c757d;">${stats.error || 0}</div>
                                <div style="color: #666;">‚ö†Ô∏è –û—à–∏–±–∫–∏</div>
                            </div>
                        </div>
                        <div style="margin-top: 15px; text-align: center; color: #666;">
                            –í—Å–µ–≥–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ: <strong>${data.total || 0}</strong>
                        </div>
                    </div>
                `;
                
                // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                let resultsHtml = '<h3>üìã –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</h3><div style="max-height: 500px; overflow-y: auto;">';
                resultsHtml += '<table class="data-table" style="width: 100%;">';
                resultsHtml += '<thead><tr><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–µ—Ç–∞–ª–∏</th><th>–ú–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å</th><th>–ú–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –≥—Ä—É–ø–ø—ã</th></tr></thead><tbody>';
                
                data.results.forEach(r => {
                    const check = r.check_result || {};
                    const status = check.status || 'unknown';
                    let statusBadge = '';
                    let statusColor = '#6c757d';
                    
                    if (status === 'ok') {
                        statusBadge = '<span class="badge badge-success">‚úÖ OK</span>';
                        statusColor = '#28a745';
                    } else if (status === 'shadow_ban') {
                        statusBadge = '<span class="badge badge-warning">üåë Shadow Ban</span>';
                        statusColor = '#ffc107';
                    } else if (status === 'flood_limit') {
                        statusBadge = '<span class="badge badge-danger">‚ùÑÔ∏è Flood Limit</span>';
                        statusColor = '#dc3545';
                    } else if (status === 'restricted') {
                        statusBadge = '<span class="badge badge-secondary">üö´ Restricted</span>';
                        statusColor = '#6c757d';
                    } else {
                        statusBadge = '<span class="badge badge-secondary">‚ö†Ô∏è Error</span>';
                        statusColor = '#6c757d';
                    }
                    
                    const details = check.details || {};
                    let detailsText = '';
                    if (details.shadow_ban) detailsText += details.shadow_ban + '<br>';
                    if (details.flood_error) detailsText += 'Flood: ' + details.flood_error + '<br>';
                    if (details.restriction) detailsText += 'Restriction: ' + details.restriction + '<br>';
                    if (details.error) detailsText += 'Error: ' + details.error + '<br>';
                    if (!detailsText) detailsText = '-';
                    
                    resultsHtml += `
                        <tr>
                            <td><strong>${r.phone || 'Unknown'}</strong></td>
                            <td>${statusBadge}</td>
                            <td style="font-size: 12px; color: #666;">${detailsText}</td>
                            <td>${check.can_send_messages ? '‚úÖ' : '‚ùå'}</td>
                            <td>${check.can_create_groups ? '‚úÖ' : '‚ùå'}</td>
                        </tr>
                    `;
                });
                
                resultsHtml += '</tbody></table></div>';
                
                document.getElementById('restrictions-status').innerHTML = statsHtml;
                document.getElementById('restrictions-results').innerHTML = resultsHtml;
            } else {
                document.getElementById('restrictions-status').innerHTML = 
                    '<div class="error">–û—à–∏–±–∫–∞: ' + (data.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</div>';
            }
        } catch (error) {
            document.getElementById('restrictions-status').innerHTML = 
                '<div class="error">–û—à–∏–±–∫–∞: ' + error.message + '</div>';
        }
    }
    
    // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ—ë
    window.addEventListener('click', function(event) {
        const restrictionsModal = document.getElementById('restrictions-modal');
        if (event.target == restrictionsModal) {
            closeRestrictionsModal();
        }
    });
    
    let currentGetCodeRequest = null;
    
    function showGetCodeModal(phoneNumber = '') {
        document.getElementById('get-code-modal').style.display = 'block';
        document.getElementById('get-code-form').style.display = 'block';
        document.getElementById('code-input-section').style.display = 'none';
        document.getElementById('direct-code-section').style.display = 'none';
        document.getElementById('get-code-status').innerHTML = '';
        
        // –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω –Ω–æ–º–µ—Ä, –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å –µ–≥–æ
        if (phoneNumber) {
            document.querySelector('input[name="phone_number"]').value = phoneNumber;
            document.getElementById('direct-phone').value = phoneNumber;
        }
    }
    
    function showDirectCodeInput() {
        const phoneInput = document.querySelector('input[name="phone_number"]');
        const phone = phoneInput.value;
        
        if (!phone) {
            alert('–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞');
            return;
        }
        
        document.getElementById('get-code-form').style.display = 'none';
        document.getElementById('direct-code-section').style.display = 'block';
        document.getElementById('direct-phone').value = phone;
        document.getElementById('direct-code').value = '';
        document.getElementById('direct-code').focus();
        document.getElementById('get-code-status').innerHTML = 
            '<div class="badge badge-info">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –≤—ã —É–∂–µ –ø–æ–ª—É—á–∏–ª–∏ –≤ Telegram</div>';
    }
    
    function cancelDirectCode() {
        document.getElementById('direct-code-section').style.display = 'none';
        document.getElementById('get-code-form').style.display = 'block';
        document.getElementById('get-code-status').innerHTML = '';
    }
    
    async function submitDirectCode() {
        const phone = document.getElementById('direct-phone').value;
        const code = document.getElementById('direct-code').value;
        const password = document.getElementById('direct-password').value;
        
        if (!phone || !code) {
            alert('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏ –∫–æ–¥');
            return;
        }
        
        document.getElementById('get-code-status').innerHTML = 
            '<div class="loading">–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞...</div>';
        
        try {
            const res = await fetch('/api/v1/sessions/verify-code-direct', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    phone_number: phone,
                    code: code,
                    password: password || null
                })
            });
            
            const data = await res.json();
            
            if (res.ok && data.status === 'success') {
                document.getElementById('get-code-status').innerHTML = 
                    '<div class="badge badge-success">Session –ø–æ–ª—É—á–µ–Ω! –§–∞–π–ª: ' + data.filename + '</div>';
                setTimeout(() => {
                    closeGetCodeModal();
                    refreshSessions();
                }, 2000);
            } else if (data.status === 'need_password') {
                document.getElementById('direct-password-section').style.display = 'block';
                document.getElementById('get-code-status').innerHTML = 
                    '<div class="badge badge-warning">–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Ä–æ–ª—å 2FA</div>';
            } else {
                document.getElementById('get-code-status').innerHTML = 
                    '<div class="error">–û—à–∏–±–∫–∞: ' + (data.detail || '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥. –í–æ–∑–º–æ–∂–Ω–æ –Ω—É–∂–µ–Ω –Ω–æ–≤—ã–π –∫–æ–¥ —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É.') + '</div>';
            }
        } catch (error) {
            document.getElementById('get-code-status').innerHTML = 
                '<div class="error">–û—à–∏–±–∫–∞: ' + error.message + '</div>';
        }
    }
    
    function getCodeForPhone(phone) {
        showGetCodeModal(phone);
    }
    
    function closeGetCodeModal() {
        document.getElementById('get-code-modal').style.display = 'none';
        if (currentGetCodeRequest) {
            // –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –µ—Å–ª–∏ –µ—Å—Ç—å
        }
    }
    
    async function startGetCode(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        const phone = formData.get('phone_number');
        
        document.getElementById('get-code-status').innerHTML = 
            '<div class="loading">–ó–∞–ø—Ä–æ—Å –∫–æ–¥–∞ –≤ Telegram –¥–ª—è ' + phone + '...<br>–ö–æ–¥ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram –Ω–∞ —ç—Ç–æ—Ç –Ω–æ–º–µ—Ä</div>';
        
        try {
            const res = await fetchWithTimeout('/api/v1/sessions/get-code', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({phone_number: phone})
            }, 10000);
            
            // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ—Ç–≤–µ—Ç JSON
            const contentType = res.headers.get('content-type');
            let data;
            
            if (contentType && contentType.includes('application/json')) {
                data = await res.json();
            } else {
                // –ï—Å–ª–∏ –Ω–µ JSON, –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∫–∞–∫ —Ç–µ–∫—Å—Ç
                const text = await res.text();
                console.error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ JSON:', text.substring(0, 200));
                throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
            }
            
            if (res.ok && data.status === 'code_sent') {
                document.getElementById('get-code-form').style.display = 'none';
                document.getElementById('code-input-section').style.display = 'block';
                document.getElementById('get-code-status').innerHTML = 
                    '<div class="badge badge-success">–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ ' + phone + '!<br>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ Telegram - –∫–æ–¥ –¥–æ–ª–∂–µ–Ω –ø—Ä–∏–π—Ç–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ –º–∏–Ω—É—Ç—ã. –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –Ω–∏–∂–µ.</div>';
                currentGetCodeRequest = {phone: phone, phone_code_hash: data.phone_code_hash};
                // –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ –∫–æ–¥–∞
                document.getElementById('telegram-code').value = '';
                document.getElementById('telegram-code').focus();
                
                // –ù–∞—á–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∫–æ–¥–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã)
                startAutoCodeCheck(phone);
            } else if (data.status === 'session_exists' || data.status === 'already_authorized') {
                document.getElementById('get-code-status').innerHTML = 
                    '<div class="badge badge-warning">–ê–∫–∫–∞—É–Ω—Ç —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω. Session –Ω–∞–π–¥–µ–Ω: ' + (data.session_file || '—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π session') + '</div>';
                setTimeout(() => {
                    closeGetCodeModal();
                    refreshSessions();
                }, 2000);
            } else {
                // –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—à–∏–±–∫—É 429 (Too Many Requests - –Ω—É–∂–Ω–æ –ø–æ–¥–æ–∂–¥–∞—Ç—å)
                if (res.status === 429 || (data.detail && data.detail.includes('–ø–æ–¥–æ–∂–¥–∞—Ç—å'))) {
                    const waitMatch = data.detail.match(/(\d+)\s*(—Å–µ–∫—É–Ω–¥|–º–∏–Ω|—Å–µ–∫)/);
                    const waitTime = waitMatch ? waitMatch[1] : '60';
                    document.getElementById('get-code-status').innerHTML = 
                        '<div class="badge badge-warning">‚è±Ô∏è ' + (data.detail || `Telegram —Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥–æ–∂–¥–∞—Ç—å ${waitTime} —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–æ–π –∫–æ–¥–∞. –≠—Ç–æ –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞.`) + '</div>';
                } else {
                    document.getElementById('get-code-status').innerHTML = 
                        '<div class="error">–û—à–∏–±–∫–∞: ' + (data.detail || data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</div>';
                }
            }
        } catch (error) {
            let errorMsg = error.message;
            if (errorMsg.includes('JSON') || errorMsg.includes('Unexpected token')) {
                errorMsg = '–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç. –í–æ–∑–º–æ–∂–Ω–æ, –Ω—É–∂–Ω–æ –ø–æ–¥–æ–∂–¥–∞—Ç—å –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–æ–π –∫–æ–¥–∞.';
            }
            document.getElementById('get-code-status').innerHTML = 
                '<div class="error">‚ùå –û—à–∏–±–∫–∞: ' + errorMsg + '</div>';
        }
    }
    
    async function submitCode() {
        const code = document.getElementById('telegram-code').value;
        const password = document.getElementById('telegram-password').value;
        
        if (!code) {
            alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ Telegram');
            return;
        }
        
        document.getElementById('get-code-status').innerHTML = 
            '<div class="loading">‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞...</div>';
        
        try {
            const res = await fetch('/api/v1/sessions/verify-code', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    phone_number: currentGetCodeRequest.phone,
                    phone_code_hash: currentGetCodeRequest.phone_code_hash,
                    code: code,
                    password: password || null
                })
            });
            
            const data = await res.json();
            
            if (res.ok && data.status === 'success') {
                document.getElementById('get-code-status').innerHTML = 
                    '<div class="badge badge-success">‚úÖ Session –ø–æ–ª—É—á–µ–Ω! –§–∞–π–ª: ' + data.filename + '</div>';
                setTimeout(() => {
                    closeGetCodeModal();
                    refreshSessions();
                }, 2000);
            } else if (data.need_password) {
                document.getElementById('password-section').style.display = 'block';
                document.getElementById('get-code-status').innerHTML = 
                    '<div class="badge badge-warning">üîí –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Ä–æ–ª—å 2FA</div>';
            } else {
                document.getElementById('get-code-status').innerHTML = 
                    '<div class="error">‚ùå –û—à–∏–±–∫–∞: ' + (data.detail || '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥') + '</div>';
            }
        } catch (error) {
            document.getElementById('get-code-status').innerHTML = 
                '<div class="error">‚ùå –û—à–∏–±–∫–∞: ' + error.message + '</div>';
        }
    }
    
    function cancelGetCode() {
        closeGetCodeModal();
        currentGetCodeRequest = null;
        if (autoCodeCheckInterval) {
            clearInterval(autoCodeCheckInterval);
            autoCodeCheckInterval = null;
        }
    }
    
    let autoCodeCheckInterval = null;
    
    async function startAutoCodeCheck(phone) {
        // –ü—Ä–æ–≤–µ—Ä—è—Ç—å –∫–æ–¥ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
        let attempts = 0;
        const maxAttempts = 35; // 70 —Å–µ–∫—É–Ω–¥ –º–∞–∫—Å–∏–º—É–º (–∫–æ–¥ –º–æ–∂–µ—Ç –ø—Ä–∏–π—Ç–∏ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π)
        
        autoCodeCheckInterval = setInterval(async () => {
            attempts++;
            
            if (attempts > maxAttempts) {
                clearInterval(autoCodeCheckInterval);
                autoCodeCheckInterval = null;
                document.getElementById('get-code-status').innerHTML = 
                    '<div class="badge badge-warning">–ö–æ–¥ –Ω–µ –ø–æ–ª—É—á–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –≤—Ä—É—á–Ω—É—é.</div>';
                return;
            }
            
            try {
                // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—É—á–µ–Ω –ª–∏ –∫–æ–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                const res = await fetch(`/api/v1/sessions/check-code/${encodeURIComponent(phone)}`);
                const data = await res.json();
                
                if (data.status === 'code_found' && data.code) {
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å –∫–æ–¥
                    document.getElementById('telegram-code').value = data.code;
                    document.getElementById('get-code-status').innerHTML = 
                        '<div class="badge badge-success">–ö–æ–¥ –ø–æ–ª—É—á–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏! –ü—Ä–æ–≤–µ—Ä–∫–∞...</div>';
                    clearInterval(autoCodeCheckInterval);
                    autoCodeCheckInterval = null;
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å
                    setTimeout(() => submitCode(), 500);
                } else if (data.status === 'session_created') {
                    // Session —É–∂–µ —Å–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                    document.getElementById('get-code-status').innerHTML = 
                        '<div class="badge badge-success">Session —Å–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏! –§–∞–π–ª: ' + (data.filename || '—Å–æ–∑–¥–∞–Ω') + '</div>';
                    clearInterval(autoCodeCheckInterval);
                    autoCodeCheckInterval = null;
                    setTimeout(() => {
                        closeGetCodeModal();
                        refreshSessions();
                    }, 2000);
                }
            } catch (error) {
                // –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏
            }
        }, 2000);
    }
    
    // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ—ë
    window.onclick = function(event) {
        const modal = document.getElementById('get-code-modal');
        if (event.target == modal) {
            closeGetCodeModal();
        }
    }
    
    // ===== –ü–∞—Ä—Å–∏–Ω–≥ –∫–æ–¥–∞ –∏–∑ Telegram =====
    
    function showParseCodeModal(phone) {
        document.getElementById('parse-code-modal').style.display = 'block';
        document.getElementById('parse-code-status').innerHTML = '<div class="loading">–ü–∞—Ä—Å–∏–Ω–≥ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ Telegram...</div>';
        document.getElementById('parse-code-result').style.display = 'none';
    }
    
    function closeParseCodeModal() {
        document.getElementById('parse-code-modal').style.display = 'none';
    }
    
    async function parseCodeFromSession(phone) {
        showParseCodeModal(phone);
        
        try {
            const res = await fetch('/api/v1/sessions/parse-code', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({phone_number: phone})
            });
            
            const data = await res.json();
            console.log('Parse response:', data);
            
            if (res.ok && data.status === 'found') {
                document.getElementById('parse-code-status').innerHTML = '';
                document.getElementById('parse-code-result').style.display = 'block';
                document.getElementById('parsed-code-value').textContent = data.code;
                
                // –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –∫–æ–¥—ã
                let codesHtml = '<p class="code-info">' + data.message + '</p>';
                if (data.all_codes && data.all_codes.length > 1) {
                    codesHtml += '<p style="margin-top:10px"><b>–í—Å–µ –∫–æ–¥—ã:</b></p><ul style="text-align:left">';
                    data.all_codes.forEach(c => {
                        codesHtml += '<li><b>' + c.code + '</b> (' + (c.hours_ago || 0) + ' —á. –Ω–∞–∑–∞–¥)</li>';
                    });
                    codesHtml += '</ul>';
                }
                document.getElementById('code-message').innerHTML = codesHtml;
            } else if (data.status === 'not_found') {
                // –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                let html = '<div class="badge badge-warning">–ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω</div>';
                if (data.all_messages && data.all_messages.length > 0) {
                    html += '<p style="margin-top:15px"><b>–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç Telegram:</b></p>';
                    html += '<div style="text-align:left; max-height:200px; overflow-y:auto; font-size:12px; background:#f5f5f5; padding:10px; border-radius:5px">';
                    data.all_messages.forEach((m, i) => {
                        html += '<div style="margin-bottom:8px; padding-bottom:8px; border-bottom:1px solid #ddd">';
                        html += '<small style="color:#888">' + (m.seconds_ago ? Math.round(m.seconds_ago/60) + ' –º–∏–Ω. –Ω–∞–∑–∞–¥' : '') + '</small><br>';
                        html += m.text;
                        html += '</div>';
                    });
                    html += '</div>';
                }
                document.getElementById('parse-code-status').innerHTML = html;
                document.getElementById('parse-code-result').style.display = 'none';
            } else {
                document.getElementById('parse-code-status').innerHTML = 
                    '<div class="error">–û—à–∏–±–∫–∞: ' + (data.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</div>';
            }
        } catch (error) {
            document.getElementById('parse-code-status').innerHTML = 
                '<div class="error">–û—à–∏–±–∫–∞: ' + error.message + '</div>';
        }
    }
    
    function copyCode() {
        const code = document.getElementById('parsed-code-value').textContent;
        navigator.clipboard.writeText(code).then(() => {
            const btn = document.querySelector('.btn-copy');
            btn.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
            setTimeout(() => {
                btn.textContent = 'üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
            }, 2000);
        }).catch(err => {
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å: ' + err);
        });
    }
    
    function copy2FA(button) {
        // –ü–æ–ª—É—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–∞
        const password = button.getAttribute('data-2fa');
        
        // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –ø—É—Å—Ç–æ–µ
        if (!password) {
            alert('2FA –ø–∞—Ä–æ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
            console.error('2FA –ø–∞—Ä–æ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ data-–∞—Ç—Ä–∏–±—É—Ç–µ');
            return;
        }
        
        // –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞
        const textToCopy = String(password);
        
        console.log('–ö–æ–ø–∏—Ä—É—é 2FA:', textToCopy);
        
        navigator.clipboard.writeText(textToCopy).then(() => {
            // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            const notification = document.createElement('div');
            notification.className = 'copy-notification';
            notification.textContent = '‚úÖ 2FA —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω: ' + textToCopy;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.remove();
            }, 2000);
        }).catch(err => {
            console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
            // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
            try {
                const textArea = document.createElement('textarea');
                textArea.value = textToCopy;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                const notification = document.createElement('div');
                notification.className = 'copy-notification';
                notification.textContent = '‚úÖ 2FA —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω: ' + textToCopy;
                document.body.appendChild(notification);
                setTimeout(() => {
                    notification.remove();
                }, 2000);
            } catch (fallbackErr) {
                console.error('Fallback –æ—à–∏–±–∫–∞:', fallbackErr);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å: ' + fallbackErr);
            }
        });
    }
    
    // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É –ø–∞—Ä—Å–∏–Ω–≥–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ—ë
    window.addEventListener('click', function(event) {
        const parseModal = document.getElementById('parse-code-modal');
        if (event.target == parseModal) {
            closeParseCodeModal();
        }
    });
    
    // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    loadSessions();
    
    // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –ø—Ä–∏ —É—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('beforeunload', function() {
        if (autoCodeCheckInterval) {
            clearInterval(autoCodeCheckInterval);
        }
        if (activityTimerInterval) {
            clearInterval(activityTimerInterval);
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('error', function(e) {
        console.error('Page error:', e);
    });
    
    window.addEventListener('unhandledrejection', function(e) {
        console.error('Unhandled promise rejection:', e);
        e.preventDefault();
    });
</script>
{% endblock %}

