{% extends "base.html" %}

{% block title %}Groups - Telegram Farm{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1 class="page-title">Groups & AI Chat</h1>
        <div>
            <button class="btn btn-primary" onclick="showAutoCreateModal()">ü§ñ –ê–≤—Ç–æ-—Å–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø</button>
            <button class="btn btn-info" onclick="checkAndCreateGroups(event)" style="background: #17a2b8; color: white;">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ —Å–æ–∑–¥–∞—Ç—å –¥–ª—è –Ω–æ–≤—ã—Ö</button>
            <button id="auto-chat-btn" class="btn btn-success" onclick="toggleAutoChat()" style="background: #28a745;">‚ñ∂Ô∏è –ê–≤—Ç–æ-—á–∞—Ç</button>
            <button class="btn btn-danger" onclick="deleteAllGroups()" style="background: #dc3545;">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
            <button class="btn btn-secondary" onclick="loadGroups()">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
    </div>
    
    <!-- AI Settings Panel -->
    <div class="card" id="ai-settings-panel" style="margin-bottom: 20px; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);">
        <div class="card-body" style="padding: 15px;">
            <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                <span style="color: #fff; font-weight: bold;">ü§ñ AI:</span>
                <span id="ai-status-badge" style="padding: 5px 15px; border-radius: 20px; font-size: 12px;">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                <input type="text" id="ai-key-input" placeholder="Groq API –∫–ª—é—á (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π!)" 
                    style="flex: 1; min-width: 300px; padding: 8px 15px; border-radius: 20px; border: 2px solid #4a4a6a; background: #0f0f23; color: white;">
                <button onclick="setAIKey()" class="btn btn-primary" style="border-radius: 20px; padding: 8px 20px;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <a href="https://console.groq.com" target="_blank" style="color: #4fc3f7; text-decoration: none; font-size: 12px;">üÜì –ü–æ–ª—É—á–∏—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–ª—é—á</a>
            </div>
        </div>
    </div>

    <!-- Proxy & Device Panel -->
    <div class="card" id="proxy-panel" style="margin-bottom: 20px; background: linear-gradient(135deg, #162447 0%, #1f4068 100%);">
        <div class="card-body" style="padding: 15px;">
            <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                <span style="color: #fff; font-weight: bold;">üåê –ü—Ä–æ–∫—Å–∏:</span>
                <span id="proxy-status-badge" style="padding: 5px 15px; border-radius: 20px; font-size: 12px; background: #333; color: #999;">0 / 0</span>
                <button onclick="showProxyModal()" class="btn" style="border-radius: 20px; padding: 8px 20px; background: #4a4a6a; color: white;">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                <button onclick="checkProxies()" class="btn" style="border-radius: 20px; padding: 8px 20px; background: #2e7d32; color: white;">‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
                <button onclick="autoAssignProxies()" class="btn" style="border-radius: 20px; padding: 8px 20px; background: #1565c0; color: white;">üîó –ù–∞–∑–Ω–∞—á–∏—Ç—å</button>
                
                <span style="color: #fff; font-weight: bold; margin-left: 20px;">üì± Device:</span>
                <span id="device-status-badge" style="padding: 5px 15px; border-radius: 20px; font-size: 12px; background: #333; color: #999;">0 —É—Å—Ç—Ä.</span>
                <button onclick="generateDevices()" class="btn" style="border-radius: 20px; padding: 8px 20px; background: #7b1fa2; color: white;">üé≤ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Live Logs Panel - –ù–ê–í–ï–†–•–£ -->
    <div class="card" id="live-logs-panel" style="margin-bottom: 20px;">
        <div class="card-header" style="background: #1a1a2e; color: white; display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0; font-size: 16px;">üì° Live Logs</h2>
            <div>
                <span id="progress-indicator" style="margin-right: 15px;"></span>
                <button class="btn btn-sm" onclick="clearLogs()" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 5px;">–û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
        </div>
        <div id="live-logs-content" style="
            height: 200px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            padding: 10px;
            background: #0f0f23;
            color: #00ff00;
        ">
            <div style="color: #666;">üîÑ –û–∂–∏–¥–∞–Ω–∏–µ –ª–æ–≥–æ–≤... –ù–∞–∂–º–∏—Ç–µ "‚ñ∂Ô∏è –ê–≤—Ç–æ-—á–∞—Ç" —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</div>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">üë•</div>
            <div class="stat-info">
                <h3 id="groups-total">0</h3>
                <p>–ì—Ä—É–ø–ø —Å–æ–∑–¥–∞–Ω–æ</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üí¨</div>
            <div class="stat-info">
                <h3 id="active-chats">0</h3>
                <p>–ê–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üì±</div>
            <div class="stat-info">
                <h3 id="total-sessions">0</h3>
                <p>–°–µ—Å—Å–∏–π –¥–æ—Å—Ç—É–ø–Ω–æ</p>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h2>–í—Å–µ –≥—Ä—É–ø–ø—ã</h2>
        </div>
        <div class="card-body">
            <div id="groups-list" class="table-container">
                <p class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä—É–ø–ø...</p>
            </div>
        </div>
    </div>
    
    <!-- –õ–æ–≥ —á–∞—Ç–∞ -->
    <div class="card" id="chat-log-card" style="display: none;">
        <div class="card-header">
            <h2>üí¨ –õ–æ–≥ —á–∞—Ç–∞</h2>
            <button class="btn btn-sm" onclick="closeChatLog()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
        <div class="card-body">
            <div id="chat-log-content" class="chat-log">
            </div>
        </div>
    </div>
    
</div>

<!-- Modal –¥–ª—è –∞–≤—Ç–æ-—Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø -->
<div id="auto-create-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø</h2>
            <button class="modal-close" onclick="closeAutoCreateModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p>–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–æ–±—å–µ—Ç –≤—Å–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã –Ω–∞ –≥—Ä—É–ø–ø—ã —Å —Ä–∞–Ω–¥–æ–º–Ω—ã–º —Ä–∞–∑–º–µ—Ä–æ–º.</p>
            
            <div id="auto-create-status"></div>
            
            <form id="auto-create-form" onsubmit="autoCreateGroups(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>–ú–∏–Ω. —Ä–∞–∑–º–µ—Ä –≥—Ä—É–ø–ø—ã</label>
                        <input type="number" name="min_group_size" value="5" min="2" max="10">
                    </div>
                    <div class="form-group">
                        <label>–ú–∞–∫—Å. —Ä–∞–∑–º–µ—Ä –≥—Ä—É–ø–ø—ã</label>
                        <input type="number" name="max_group_size" value="10" min="2" max="20">
                    </div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" name="random_size" checked>
                        –†–∞–Ω–¥–æ–º–Ω—ã–π —Ä–∞–∑–º–µ—Ä (–æ—Ç –º–∏–Ω –¥–æ –º–∞–∫—Å)
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" name="assign_topics" checked>
                        –ù–∞–∑–Ω–∞—á–∏—Ç—å —Å–ª—É—á–∞–π–Ω—ã–µ —Ç–µ–º—ã –¥–ª—è –æ–±—â–µ–Ω–∏—è
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" name="create_telegram" checked>
                        üöÄ –°–æ–∑–¥–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –≥—Ä—É–ø–ø—ã –≤ Telegram
                    </label>
                    <small style="display: block; color: #666; margin-top: 5px;">
                        –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Å—Ç TG –≥—Ä—É–ø–ø—ã –∏ –¥–æ–±–∞–≤–∏—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                    </small>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeAutoCreateModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary" id="create-groups-btn">üöÄ –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—ã</button>
                </div>
            </form>
            
            <div id="creation-results" style="display: none; margin-top: 1rem;">
                <h3>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è</h3>
                <div id="results-summary" class="stats-box"></div>
                <div id="results-table"></div>
            </div>
        </div>
    </div>
</div>

<!-- Modal –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —á–∞—Ç–∞ —Å –≤—ã–±–æ—Ä–æ–º —Ç–µ–º—ã -->
<div id="start-chat-modal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h2>üí¨ –ó–∞–ø—É—Å—Ç–∏—Ç—å AI —á–∞—Ç</h2>
            <button class="modal-close" onclick="closeStartChatModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è. –£—á–∞—Å—Ç–Ω–∏–∫–∏ –±—É–¥—É—Ç –æ–±—â–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ OpenAI –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é —Ç–µ–º—É.</p>
            
            <div id="start-chat-status"></div>
            
            <form id="start-chat-form" onsubmit="submitStartChat(event)">
                <input type="hidden" name="group_id" id="chat-group-id">
                
                <div class="form-group">
                    <label>–¢–µ–º–∞ –æ–±—Å—É–∂–¥–µ–Ω–∏—è</label>
                    <select name="topic_id" id="topic-select" class="form-control">
                        <option value="travel">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–º...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ —Ç–µ–º—ã</label>
                    <p id="topic-description" class="topic-desc">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ–ø–∏—Å–∞–Ω–∏—è</p>
                </div>
                
                <div class="form-group">
                    <label>–°–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ —É—á–∞—Å—Ç–Ω–∏–∫–∞</label>
                    <input type="number" name="messages_per_member" value="2" min="1" max="10">
                    <small>–ö–∞–∂–¥—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ –æ—Ç–ø—Ä–∞–≤–∏—Ç —ç—Ç–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π</small>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeStartChatModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary" id="start-chat-btn">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å —á–∞—Ç</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≥—Ä—É–ø–ø—ã -->
<div id="view-group-modal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h2 id="view-group-title">–ì—Ä—É–ø–ø–∞</h2>
            <button class="modal-close" onclick="closeViewGroupModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="view-group-content">
            </div>
        </div>
    </div>
</div>

<!-- Modal –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–∫—Å–∏ -->
<div id="proxy-modal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h2>üåê –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–∫—Å–∏</h2>
            <button class="modal-close" onclick="closeProxyModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p style="margin-bottom: 15px;">–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–∫—Å–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ <code>ip:port:login:password</code> (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É)</p>
            
            <div id="proxy-upload-status"></div>
            
            <div class="form-group">
                <label>–°–ø–∏—Å–æ–∫ SOCKS5 –ø—Ä–æ–∫—Å–∏:</label>
                <textarea id="proxies-textarea" rows="10" style="width: 100%; font-family: monospace; padding: 10px; border-radius: 5px; border: 1px solid #444; background: #1a1a2e; color: #fff;" placeholder="185.123.45.67:1080:user1:pass1
185.123.45.68:1080:user2:pass2
..."></textarea>
            </div>
            
            <div class="form-actions" style="margin-top: 15px;">
                <button type="button" class="btn btn-secondary" onclick="closeProxyModal()">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" onclick="uploadProxies()">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<style>
.topic-desc {
    background: var(--bg);
    padding: 1rem;
    border-radius: 0.5rem;
    font-size: 0.9rem;
    color: var(--text-light);
    margin: 0;
}

#topic-select {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--border);
    border-radius: 0.5rem;
    font-size: 1rem;
    background: var(--card-bg);
    cursor: pointer;
}

#topic-select:focus {
    outline: none;
    border-color: var(--primary);
}
</style>
{% endblock %}

{% block extra_js %}
<script>
    let currentGroups = [];
    let allTopics = [];
    
    // ========== FETCH –° –¢–ê–ô–ú–ê–£–¢–û–ú (—á—Ç–æ–±—ã –Ω–µ –∑–∞–≤–∏—Å–∞–ª–æ) ==========
    async function fetchWithTimeout(url, options = {}, timeout = 10000) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeout);
        
        try {
            const response = await fetch(url, {
                ...options,
                signal: controller.signal
            });
            clearTimeout(timeoutId);
            return response;
        } catch (error) {
            clearTimeout(timeoutId);
            if (error.name === 'AbortError') {
                throw new Error(`–¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ (${timeout}–º—Å): ${url}`);
            }
            throw error;
        }
    }
    
    // ========== AI KEY FUNCTIONS ==========
    
    async function loadAIStatus() {
        try {
            const res = await fetchWithTimeout('/api/v1/ai/status', {}, 5000);
            const data = await res.json();
            
            const badge = document.getElementById('ai-status-badge');
            const input = document.getElementById('ai-key-input');
            
            if (data.has_key) {
                badge.style.background = '#28a745';
                badge.style.color = 'white';
                badge.textContent = '‚úÖ ' + data.provider_name;
                if (data.key_preview) {
                    input.placeholder = data.key_preview;
                }
            } else {
                badge.style.background = '#ffc107';
                badge.style.color = 'black';
                badge.textContent = '‚ö†Ô∏è –ù–µ—Ç –∫–ª—é—á–∞';
                input.placeholder = '–í—Å—Ç–∞–≤—å Groq –∫–ª—é—á (–±–µ—Å–ø–ª–∞—Ç–Ω–æ!)';
            }
        } catch (error) {
            console.error('AI status error:', error);
            const badge = document.getElementById('ai-status-badge');
            badge.style.background = '#dc3545';
            badge.style.color = 'white';
            badge.textContent = '‚ùå –û—à–∏–±–∫–∞';
        }
    }
    
    async function setAIKey() {
        const input = document.getElementById('ai-key-input');
        const key = input.value.trim();
        
        if (!key) {
            alert('–í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á!');
            return;
        }
        
        try {
            const res = await fetch('/api/v1/ai/set-key', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    api_key: key,
                    provider: key.startsWith('gsk_') ? 'groq' : 'openai'  // Groq –∫–ª—é—á–∏ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å gsk_
                })
            });
            
            const data = await res.json();
            
            if (res.ok) {
                alert('‚úÖ ' + data.message);
                input.value = '';
                loadAIStatus();
            } else {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + data.detail);
            }
        } catch (error) {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
        }
    }
    
    // ========== PROXY & DEVICE FUNCTIONS ==========
    
    async function loadProxyStatus() {
        try {
            const res = await fetch('/api/v1/proxies/status');
            const data = await res.json();
            
            const badge = document.getElementById('proxy-status-badge');
            if (data.total > 0) {
                const alive = data.alive || 0;
                const total = data.total || 0;
                const assigned = data.assigned || 0;
                
                badge.style.background = alive > 0 ? '#28a745' : '#ffc107';
                badge.style.color = 'white';
                badge.textContent = `${alive}/${total} –∂–∏–≤—ã—Ö, ${assigned} –Ω–∞–∑–Ω.`;
            } else {
                badge.style.background = '#6c757d';
                badge.style.color = 'white';
                badge.textContent = '–ù–µ—Ç –ø—Ä–æ–∫—Å–∏';
            }
        } catch (error) {
            console.error('Proxy status error:', error);
        }
    }
    
    async function loadDeviceStatus() {
        try {
            const res = await fetch('/api/v1/devices/status');
            const data = await res.json();
            
            const badge = document.getElementById('device-status-badge');
            const total = data.total_assigned || 0;
            
            if (total > 0) {
                badge.style.background = '#7b1fa2';
                badge.style.color = 'white';
                badge.textContent = `${total} —É—Å—Ç—Ä.`;
            } else {
                badge.style.background = '#6c757d';
                badge.style.color = 'white';
                badge.textContent = '0 —É—Å—Ç—Ä.';
            }
        } catch (error) {
            console.error('Device status error:', error);
        }
    }
    
    function showProxyModal() {
        document.getElementById('proxy-modal').style.display = 'flex';
    }
    
    function closeProxyModal() {
        document.getElementById('proxy-modal').style.display = 'none';
    }
    
    async function uploadProxies() {
        const textarea = document.getElementById('proxies-textarea');
        const text = textarea.value.trim();
        
        if (!text) {
            alert('–í–≤–µ–¥–∏—Ç–µ —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–∫—Å–∏!');
            return;
        }
        
        const statusDiv = document.getElementById('proxy-upload-status');
        statusDiv.innerHTML = '<div class="alert alert-info">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div>';
        
        try {
            const res = await fetch('/api/v1/proxies/upload', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ proxies_text: text })
            });
            
            const data = await res.json();
            
            if (res.ok) {
                statusDiv.innerHTML = `<div class="alert alert-success">‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${data.loaded} –ø—Ä–æ–∫—Å–∏</div>`;
                textarea.value = '';
                loadProxyStatus();
                setTimeout(closeProxyModal, 1500);
            } else {
                statusDiv.innerHTML = `<div class="alert alert-danger">‚ùå ${data.detail}</div>`;
            }
        } catch (error) {
            statusDiv.innerHTML = `<div class="alert alert-danger">‚ùå ${error.message}</div>`;
        }
    }
    
    async function checkProxies() {
        const badge = document.getElementById('proxy-status-badge');
        badge.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...';
        badge.style.background = '#ffc107';
        
        try {
            const res = await fetch('/api/v1/proxies/check', { method: 'POST' });
            const data = await res.json();
            
            if (res.ok) {
                alert(`‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ: ${data.alive} –∂–∏–≤—ã—Ö, ${data.dead} –º–µ—Ä—Ç–≤—ã—Ö –∏–∑ ${data.total}`);
            } else {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + data.detail);
            }
        } catch (error) {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
        }
        
        loadProxyStatus();
    }
    
    async function autoAssignProxies() {
        try {
            const res = await fetch('/api/v1/proxies/auto-assign', { method: 'POST' });
            const data = await res.json();
            
            if (res.ok) {
                alert(`‚úÖ ${data.message}`);
            } else {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + data.detail);
            }
        } catch (error) {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
        }
        
        loadProxyStatus();
    }
    
    async function generateDevices() {
        const badge = document.getElementById('device-status-badge');
        badge.textContent = '‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è...';
        
        try {
            const res = await fetch('/api/v1/devices/generate', { method: 'POST' });
            const data = await res.json();
            
            if (res.ok) {
                alert(`‚úÖ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ ${data.generated} —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤`);
            } else {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + data.detail);
            }
        } catch (error) {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
        }
        
        loadDeviceStatus();
    }
    
    // ========== GROUPS FUNCTIONS ==========
    
    async function deleteAllGroups() {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï –≥—Ä—É–ø–ø—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) {
            return;
        }
        
        try {
            const res = await fetch('/api/v1/groups/all', { method: 'DELETE' });
            const data = await res.json();
            
            if (res.ok) {
                alert('‚úÖ ' + data.message);
                loadGroups();
            } else {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + data.detail);
            }
        } catch (error) {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
        }
    }
    
    async function checkAndCreateGroups(event) {
        console.log('checkAndCreateGroups called', event);
        
        if (!confirm('–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ —Å–µ—Å—Å–∏–∏ –∏ —Å–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—ã –¥–ª—è —Ç–µ—Ö, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —É—á–∞—Å—Ç–≤—É—é—Ç –≤ –≥—Ä—É–ø–ø–∞—Ö?')) {
            return;
        }
        
        const btn = event?.target || document.querySelector('button[onclick*="checkAndCreateGroups"]');
        const originalText = btn?.textContent || 'üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ —Å–æ–∑–¥–∞—Ç—å –¥–ª—è –Ω–æ–≤—ã—Ö';
        
        console.log('Button found:', btn, 'Original text:', originalText);
        
        try {
            if (btn) {
                btn.disabled = true;
                btn.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...';
            }
            
            console.log('Starting check...');
            addLog('üîç –ù–∞—á–∏–Ω–∞—é –ø—Ä–æ–≤–µ—Ä–∫—É —Å–µ—Å—Å–∏–π...', 'info');
            
            const requestData = {
                min_group_size: 5,
                max_group_size: 10,
                create_telegram: true,  // –°–æ–∑–¥–∞–≤–∞—Ç—å –≥—Ä—É–ø–ø—ã –≤ Telegram —Å—Ä–∞–∑—É
                assign_topics: true
            };
            
            addLog('üì° –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä...', 'info');
            addLog('‚è±Ô∏è –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ –ø–æ–¥–æ–∂–¥–∏—Ç–µ...', 'info');
            
            // –î–ª–∏—Ç–µ–ª—å–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è - —Ç–∞–π–º–∞—É—Ç 5 –º–∏–Ω—É—Ç (300 —Å–µ–∫—É–Ω–¥)
            const res = await fetchWithTimeout('/api/v1/groups/check-and-create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            }, 300000); // 5 –º–∏–Ω—É—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø
            
            addLog('üì• –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞...', 'info');
            
            let data;
            try {
                data = await res.json();
            } catch (e) {
                const text = await res.text();
                addLog('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–∞: ' + text.substring(0, 100), 'error');
                throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ' + text.substring(0, 100));
            }
            
            if (res.ok) {
                addLog(`‚úÖ ${data.message}`, 'success');
                if (data.groups_created > 0) {
                    addLog(`üìä –°–æ–∑–¥–∞–Ω–æ –≥—Ä—É–ø–ø: ${data.groups_created}`, 'success');
                    addLog(`üì± –ù–æ–≤—ã—Ö —Å–µ—Å—Å–∏–π: ${data.new_sessions_count}`, 'info');
                    addLog(`‚úÖ –í–∞–ª–∏–¥–Ω—ã—Ö —Å–µ—Å—Å–∏–π: ${data.valid_sessions_count}`, 'info');
                    if (data.telegram_created > 0) {
                        addLog(`üì± –°–æ–∑–¥–∞–Ω–æ –≤ Telegram: ${data.telegram_created}`, 'success');
                    }
                } else {
                    addLog(`‚ÑπÔ∏è –í—Å–µ —Å–µ—Å—Å–∏–∏ —É–∂–µ –≤ –≥—Ä—É–ø–ø–∞—Ö –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –Ω–æ–≤—ã—Ö —Å–µ—Å—Å–∏–π`, 'info');
                }
                alert('‚úÖ ' + data.message);
                loadGroups();
            } else {
                const errorMsg = data.detail || data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                addLog('‚ùå –û—à–∏–±–∫–∞: ' + errorMsg, 'error');
                alert('‚ùå –û—à–∏–±–∫–∞: ' + errorMsg);
            }
        } catch (error) {
            console.error('Error in checkAndCreateGroups:', error);
            let errorMsg = error.message;
            
            // –ï—Å–ª–∏ —Ç–∞–π–º–∞—É—Ç - –æ–±—ä—è—Å–Ω–∏—Ç—å, —á—Ç–æ –æ–ø–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
            if (errorMsg.includes('–¢–∞–π–º–∞—É—Ç')) {
                errorMsg += '\n\n‚ö†Ô∏è –í–ê–ñ–ù–û: –û–ø–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ!\n–û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç.';
                addLog('‚è±Ô∏è –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞, –Ω–æ –æ–ø–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ...', 'warning');
                addLog('üí° –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç', 'info');
            }
            
            addLog('‚ùå –û—à–∏–±–∫–∞: ' + errorMsg, 'error');
            alert('‚ùå –û—à–∏–±–∫–∞: ' + errorMsg);
        } finally {
            if (btn) {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }
    }
    
    // –ê–≤—Ç–æ-—á–∞—Ç
    let autoChatRunning = false;
    
    async function toggleAutoChat() {
        const btn = document.getElementById('auto-chat-btn');
        
        if (autoChatRunning) {
            // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
            try {
                const res = await fetch('/api/v1/auto-chat/stop', { method: 'POST' });
                const data = await res.json();
                
                autoChatRunning = false;
                btn.textContent = '‚ñ∂Ô∏è –ê–≤—Ç–æ-—á–∞—Ç';
                btn.style.background = '#28a745';
                alert('‚èπÔ∏è –ê–≤—Ç–æ-—á–∞—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            }
        } else {
            // –ó–∞–ø—É—Å—Ç–∏—Ç—å
            try {
                btn.textContent = '‚è≥ –ó–∞–ø—É—Å–∫...';
                btn.disabled = true;
                
                const res = await fetch('/api/v1/auto-chat/start', { method: 'POST' });
                const data = await res.json();
                
                btn.disabled = false;
                
                if (data.status === 'success') {
                    autoChatRunning = true;
                    btn.textContent = '‚èπÔ∏è –°—Ç–æ–ø';
                    btn.style.background = '#dc3545';
                    alert('‚úÖ ' + data.message);
                } else {
                    btn.textContent = '‚ñ∂Ô∏è –ê–≤—Ç–æ-—á–∞—Ç';
                    alert('‚ùå ' + data.message);
                }
            } catch (error) {
                btn.disabled = false;
                btn.textContent = '‚ñ∂Ô∏è –ê–≤—Ç–æ-—á–∞—Ç';
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            }
        }
    }
    
    async function checkAutoChatStatus() {
        try {
            const res = await fetch('/api/v1/auto-chat/status');
            const data = await res.json();
            
            const btn = document.getElementById('auto-chat-btn');
            if (data.active) {
                autoChatRunning = true;
                btn.textContent = '‚èπÔ∏è –°—Ç–æ–ø';
                btn.style.background = '#dc3545';
            } else {
                autoChatRunning = false;
                btn.textContent = '‚ñ∂Ô∏è –ê–≤—Ç–æ-—á–∞—Ç';
                btn.style.background = '#28a745';
            }
        } catch (error) {
            console.error('Error checking auto chat status:', error);
        }
    }
    
    async function createTgGroup(groupId) {
        if (!confirm('–°–æ–∑–¥–∞—Ç—å —Ä–µ–∞–ª—å–Ω—É—é Telegram –≥—Ä—É–ø–ø—É? –≠—Ç–æ –∑–∞–π–º—ë—Ç –≤—Ä–µ–º—è.')) return;
        
        try {
            const res = await fetch(`/api/v1/groups/${groupId}/create-telegram`, { method: 'POST' });
            const data = await res.json();
            
            if (res.ok) {
                alert('‚úÖ ' + data.message);
                loadGroups();
            } else {
                alert('‚ùå ' + data.detail);
            }
        } catch (error) {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
        }
    }
    
    async function loadGroups() {
        try {
            const res = await fetchWithTimeout('/api/v1/groups', {}, 8000); // 8 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º–∞—É—Ç
            const data = await res.json();
            
            currentGroups = data.groups || [];
            document.getElementById('groups-total').textContent = currentGroups.length;
            
            // –ü–æ–¥—Å—á–∏—Ç–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ —á–∞—Ç—ã
            const activeChats = currentGroups.filter(g => g.chat_active).length;
            document.getElementById('active-chats').textContent = activeChats;
            
            displayGroups(currentGroups);
            
            // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ—Å—Å–∏–π (—Å —Ç–∞–π–º–∞—É—Ç–æ–º)
            try {
                const sessRes = await fetchWithTimeout('/api/v1/sessions', {}, 5000);
                const sessData = await sessRes.json();
                document.getElementById('total-sessions').textContent = sessData.total || 0;
            } catch (e) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ—Å—Å–∏–π:', e);
                document.getElementById('total-sessions').textContent = '?';
            }
            
        } catch (error) {
            console.error('Error loading groups:', error);
            document.getElementById('groups-list').innerHTML = 
                `<p class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø: ${error.message}</p>`;
        }
    }
    
    async function loadTopics() {
        try {
            const res = await fetchWithTimeout('/api/v1/topics', {}, 5000);
            const data = await res.json();
            allTopics = data.topics || [];
            
            const select = document.getElementById('topic-select');
            select.innerHTML = allTopics.map(t => 
                `<option value="${t.id}">${t.name}</option>`
            ).join('');
            
            // –û–±–Ω–æ–≤–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
            select.addEventListener('change', updateTopicDescription);
            updateTopicDescription();
            
        } catch (error) {
            console.error('Error loading topics:', error);
        }
    }
    
    function updateTopicDescription() {
        const select = document.getElementById('topic-select');
        const topicId = select.value;
        const topic = allTopics.find(t => t.id === topicId);
        
        const descEl = document.getElementById('topic-description');
        if (topic) {
            descEl.textContent = topic.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è';
        }
    }
    
    function displayGroups(groups) {
        const container = document.getElementById('groups-list');
        
        if (groups.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <p>–ì—Ä—É–ø–ø—ã –Ω–µ —Å–æ–∑–¥–∞–Ω—ã</p>
                    <p>–ù–∞–∂–º–∏—Ç–µ "–ê–≤—Ç–æ-—Å–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø" —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—ã –∏–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–µ—Å—Å–∏–π</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = `
            <table class="data-table">
                <thead>
                    <tr>
                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                        <th>ID</th>
                        <th>–£—á–∞—Å—Ç–Ω–∏–∫–∏</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    ${groups.map(g => `
                        <tr>
                            <td><strong>${g.title || '–ì—Ä—É–ø–ø–∞'}</strong></td>
                            <td><code style="font-size: 0.75rem;">${g.id.substring(0, 20)}...</code></td>
                            <td>
                                <span class="badge">${g.all_phones ? g.all_phones.length : 0} —á–µ–ª.</span>
                            </td>
                            <td>
                                ${g.telegram_group_id
                                    ? '<span class="badge badge-success">‚úÖ –í TG</span>' 
                                    : '<span class="badge badge-warning">‚è≥ –ù–µ—Ç TG</span>'}
                            </td>
                            <td>
                                <button class="btn btn-sm" onclick="viewGroup('${g.id}')" title="–ü—Ä–æ—Å–º–æ—Ç—Ä">üëÅÔ∏è</button>
                                ${g.telegram_group_id
                                    ? `<button class="btn btn-sm btn-primary" onclick="showStartChatModal('${g.id}')" title="–ß–∞—Ç">üí¨</button>`
                                    : `<button class="btn btn-sm btn-warning" onclick="createTgGroup('${g.id}')" title="–°–æ–∑–¥–∞—Ç—å TG –≥—Ä—É–ø–ø—É">üì± –°–æ–∑–¥–∞—Ç—å TG</button>`
                                }
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    }
    
    function showAutoCreateModal() {
        document.getElementById('auto-create-modal').style.display = 'block';
        document.getElementById('auto-create-status').innerHTML = '';
    }
    
    function closeAutoCreateModal() {
        document.getElementById('auto-create-modal').style.display = 'none';
    }
    
    function showStartChatModal(groupId) {
        document.getElementById('chat-group-id').value = groupId;
        document.getElementById('start-chat-modal').style.display = 'block';
        document.getElementById('start-chat-status').innerHTML = '';
        loadTopics();
    }
    
    function closeStartChatModal() {
        document.getElementById('start-chat-modal').style.display = 'none';
    }
    
    async function autoCreateGroups(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        
        const btn = document.getElementById('create-groups-btn');
        btn.disabled = true;
        btn.textContent = '‚è≥ –°–æ–∑–¥–∞–Ω–∏–µ...';
        
        document.getElementById('auto-create-status').innerHTML = 
            '<div class="loading">–ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø...</div>';
        document.getElementById('creation-results').style.display = 'none';
        
        try {
            const res = await fetch('/api/v1/groups/auto-create', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    min_group_size: parseInt(formData.get('min_group_size')),
                    max_group_size: parseInt(formData.get('max_group_size')),
                    random_size: formData.get('random_size') === 'on',
                    assign_topics: formData.get('assign_topics') === 'on',
                    create_telegram: formData.get('create_telegram') === 'on'
                })
            });
            
            const data = await res.json();
            
            if (res.ok) {
                document.getElementById('auto-create-status').innerHTML = 
                    `<div class="badge badge-success">‚úÖ ${data.message}</div>`;
                
                // –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                const resultsDiv = document.getElementById('creation-results');
                resultsDiv.style.display = 'block';
                
                // –°–≤–æ–¥–∫–∞
                const summary = data.summary;
                document.getElementById('results-summary').innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-value">${summary.total_contacts}</span>
                            <span class="stat-label">–í—Å–µ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</span>
                        </div>
                        <div class="stat-item" style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);">
                            <span class="stat-value" style="color: #155724;">${summary.groups_created}</span>
                            <span class="stat-label">–ì—Ä—É–ø–ø –≥–æ—Ç–æ–≤–æ</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">${summary.contacts_distributed}</span>
                            <span class="stat-label">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–æ</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">${summary.leftover}</span>
                            <span class="stat-label">–û—Å—Ç–∞—Ç–æ–∫</span>
                        </div>
                    </div>
                `;
                
                // –¢–∞–±–ª–∏—Ü–∞ –≥—Ä—É–ø–ø
                const stats = data.group_stats || [];
                document.getElementById('results-table').innerHTML = `
                    <table class="data-table" style="margin-top: 1rem; font-size: 0.85rem;">
                        <thead>
                            <tr>
                                <th>–ì—Ä—É–ø–ø–∞</th>
                                <th>–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤</th>
                                <th>–¢–µ–º–∞</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${stats.map(s => `
                                <tr>
                                    <td>${s.title}</td>
                                    <td><strong>${s.members}</strong> —á–µ–ª.</td>
                                    <td><span class="topic-badge">${s.topic}</span></td>
                                    <td>${s.status === 'created' ? '<span class="badge badge-success">‚úÖ</span>' : '<span class="badge badge-warning">‚è≥</span>'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    loadGroups();
                }, 2000);
            } else {
                document.getElementById('auto-create-status').innerHTML = 
                    `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${data.detail}</div>`;
            }
        } catch (error) {
            document.getElementById('auto-create-status').innerHTML = 
                `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
        } finally {
            btn.disabled = false;
            btn.textContent = 'üöÄ –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—ã';
        }
    }
    
    async function createTelegramGroup(groupId) {
        if (!confirm('–°–æ–∑–¥–∞—Ç—å Telegram –≥—Ä—É–ø–ø—É? –ê–¥–º–∏–Ω –¥–æ–±–∞–≤–∏—Ç –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.')) {
            return;
        }
        
        try {
            const res = await fetch(`/api/v1/groups/${groupId}/create-telegram`, {
                method: 'POST'
            });
            
            const data = await res.json();
            
            if (res.ok) {
                alert(`–ì—Ä—É–ø–ø–∞ —Å–æ–∑–¥–∞–Ω–∞! –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${data.members_invited || 0} –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π.`);
                loadGroups();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + data.detail);
            }
        } catch (error) {
            alert('–û—à–∏–±–∫–∞: ' + error.message);
        }
    }
    
    async function submitStartChat(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        
        const groupId = formData.get('group_id');
        const topicId = formData.get('topic_id');
        const messagesPerMember = parseInt(formData.get('messages_per_member'));
        
        const topic = allTopics.find(t => t.id === topicId);
        
        document.getElementById('start-chat-status').innerHTML = 
            `<div class="loading">–ó–∞–ø—É—Å–∫ —á–∞—Ç–∞ –Ω–∞ —Ç–µ–º—É "${topic?.name || topicId}"...</div>`;
        document.getElementById('start-chat-btn').disabled = true;
        
        try {
            const res = await fetch(`/api/v1/groups/${groupId}/start-chat`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    group_id: groupId,
                    topic_id: topicId,
                    messages_per_member: messagesPerMember
                })
            });
            
            const data = await res.json();
            
            if (res.ok) {
                document.getElementById('start-chat-status').innerHTML = 
                    `<div class="badge badge-success">${data.message}</div>`;
                
                setTimeout(() => {
                    closeStartChatModal();
                    showChatLog(groupId, data.messages, topic?.name);
                }, 1000);
            } else {
                document.getElementById('start-chat-status').innerHTML = 
                    `<div class="error">–û—à–∏–±–∫–∞: ${data.detail}</div>`;
            }
        } catch (error) {
            document.getElementById('start-chat-status').innerHTML = 
                `<div class="error">–û—à–∏–±–∫–∞: ${error.message}</div>`;
        } finally {
            document.getElementById('start-chat-btn').disabled = false;
        }
    }
    
    function showChatLog(groupId, messages, topicName) {
        const card = document.getElementById('chat-log-card');
        const content = document.getElementById('chat-log-content');
        
        card.style.display = 'block';
        
        let html = '';
        if (topicName) {
            html += `<div class="chat-topic">–¢–µ–º–∞: ${topicName}</div>`;
        }
        
        if (!messages || messages.length === 0) {
            html += '<p class="empty">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</p>';
        } else {
            html += messages.map(m => `
                <div class="chat-message">
                    <div class="chat-sender">${m.sender}</div>
                    <div class="chat-text">${m.message}</div>
                    <div class="chat-time">${m.time ? new Date(m.time).toLocaleTimeString() : ''}</div>
                </div>
            `).join('');
        }
        
        content.innerHTML = html;
        content.scrollTop = content.scrollHeight;
    }
    
    function closeChatLog() {
        document.getElementById('chat-log-card').style.display = 'none';
    }
    
    function viewGroup(groupId) {
        const group = currentGroups.find(g => g.id === groupId);
        if (!group) return;
        
        document.getElementById('view-group-title').textContent = group.title || '–ì—Ä—É–ø–ø–∞';
        document.getElementById('view-group-modal').style.display = 'block';
        
        const content = document.getElementById('view-group-content');
        content.innerHTML = `
            <div class="group-details">
                <p><strong>ID:</strong> ${group.id}</p>
                <p><strong>Telegram ID:</strong> ${group.telegram_group_id || '–ù–µ —Å–æ–∑–¥–∞–Ω–∞'}</p>
                <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${group.status || 'pending'}</p>
                <p><strong>–°–æ–∑–¥–∞–Ω–∞:</strong> ${group.created_at || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</p>
                
                <h4>–ê–¥–º–∏–Ω:</h4>
                <p>üì± ${group.admin?.phone || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'} (${group.admin?.first_name || 'User'})</p>
                
                <h4>–£—á–∞—Å—Ç–Ω–∏–∫–∏ (${group.members?.length || 0}):</h4>
                <ul>
                    ${(group.members || []).map(m => `
                        <li>üì± ${m.phone} (${m.first_name || 'User'})</li>
                    `).join('')}
                </ul>
            </div>
        `;
    }
    
    function closeViewGroupModal() {
        document.getElementById('view-group-modal').style.display = 'none';
    }
    
    // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –Ω–∏—Ö
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
        }
    }
    
    // Live Logs
    let logsInterval = null;
    
    async function fetchLiveLogs() {
        try {
            const res = await fetchWithTimeout('/api/v1/live-logs', {}, 3000); // 3 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è –ª–æ–≥–æ–≤
            const data = await res.json();
            
            const logsDiv = document.getElementById('live-logs-content');
            const progressDiv = document.getElementById('progress-indicator');
            
            // –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
            if (data.progress && data.progress.active) {
                const pct = Math.round((data.progress.current / data.progress.total) * 100);
                progressDiv.innerHTML = `
                    <span style="color: #ffc107;">‚è≥ ${data.progress.current}/${data.progress.total}</span>
                    <span style="margin-left: 10px; color: #aaa;">${data.progress.message}</span>
                `;
            } else {
                progressDiv.innerHTML = '';
            }
            
            // –û–±–Ω–æ–≤–∏—Ç—å –ª–æ–≥–∏
            if (data.logs && data.logs.length > 0) {
                logsDiv.innerHTML = data.logs.map(log => {
                    let color = '#00ff00';
                    let icon = 'üìù';
                    if (log.type === 'error') { color = '#ff4444'; icon = '‚ùå'; }
                    else if (log.type === 'warning') { color = '#ffaa00'; icon = '‚ö†Ô∏è'; }
                    else if (log.type === 'success') { color = '#00ff88'; icon = '‚úÖ'; }
                    else if (log.type === 'message') { color = '#00aaff'; icon = 'üí¨'; }
                    
                    return `<div style="color: ${color}; margin-bottom: 3px;">
                        <span style="color: #666;">[${log.time}]</span> ${icon} ${log.message}
                    </div>`;
                }).join('');
                
                // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
                logsDiv.scrollTop = logsDiv.scrollHeight;
            }
        } catch (error) {
            console.error('Error fetching logs:', error);
        }
    }
    
    function startLogsPolling() {
        if (!logsInterval) {
            logsInterval = setInterval(fetchLiveLogs, 1000);
            fetchLiveLogs();
        }
    }
    
    function stopLogsPolling() {
        if (logsInterval) {
            clearInterval(logsInterval);
            logsInterval = null;
        }
    }
    
    function clearLogs() {
        document.getElementById('live-logs-content').innerHTML = 
            '<div style="color: #666;">–õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã...</div>';
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ª–æ–≥–æ–≤ –ª–æ–∫–∞–ª—å–Ω–æ
    function addLog(message, type = 'info') {
        const logsDiv = document.getElementById('live-logs-content');
        if (!logsDiv) return;
        
        let color = '#00ff00';
        let icon = 'üìù';
        if (type === 'error') { color = '#ff4444'; icon = '‚ùå'; }
        else if (type === 'warning') { color = '#ffaa00'; icon = '‚ö†Ô∏è'; }
        else if (type === 'success') { color = '#00ff88'; icon = '‚úÖ'; }
        else if (type === 'info') { color = '#00aaff'; icon = '‚ÑπÔ∏è'; }
        
        const time = new Date().toLocaleTimeString('ru-RU');
        const logEntry = document.createElement('div');
        logEntry.style.color = color;
        logEntry.style.marginBottom = '3px';
        logEntry.innerHTML = `<span style="color: #666;">[${time}]</span> ${icon} ${message}`;
        
        logsDiv.appendChild(logEntry);
        logsDiv.scrollTop = logsDiv.scrollHeight;
    }
    
    // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    loadGroups();
    loadAIStatus();  // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å AI
    loadProxyStatus();  // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–∫—Å–∏
    loadDeviceStatus();  // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤
    checkAutoChatStatus();
    startLogsPolling();
    
    // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –ø—Ä–∏ —É—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('beforeunload', function() {
        stopLogsPolling();
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('error', function(e) {
        console.error('Page error:', e);
        // –ù–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü
    });
    
    window.addEventListener('unhandledrejection', function(e) {
        console.error('Unhandled promise rejection:', e);
        e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
    });
</script>

<style>
.chat-topic {
    background: var(--primary);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    margin-bottom: 1rem;
    font-weight: 600;
}

.topic-badge {
    display: inline-block;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 0.15rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.7rem;
    margin-top: 0.25rem;
}

.form-row {
    display: flex;
    gap: 1rem;
}

.form-row .form-group {
    flex: 1;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
    margin-bottom: 1rem;
}

.stat-item {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    padding: 1rem;
    border-radius: 0.5rem;
    text-align: center;
}

.stat-value {
    display: block;
    font-size: 1.5rem;
    font-weight: bold;
    color: #5b4b8a;
}

.stat-label {
    display: block;
    font-size: 0.75rem;
    color: #666;
    margin-top: 0.25rem;
}

.stats-box {
    background: #f8f9fa;
    border-radius: 0.5rem;
    padding: 1rem;
}

#creation-results h3 {
    margin-bottom: 1rem;
    color: #5b4b8a;
}

#results-table {
    max-height: 300px;
    overflow-y: auto;
}
</style>
{% endblock %}
