{% extends "base.html" %}

{% block title %}Logs - Telegram Farm{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1 class="page-title">üìã –í—Å–µ –ª–æ–≥–∏ —Å–∏—Å—Ç–µ–º—ã</h1>
        <div>
            <button class="btn btn-danger" onclick="clearAllLogs()" style="background: #dc3545;">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ</button>
            <button class="btn btn-secondary" onclick="loadLogs()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
            <button class="btn btn-info" onclick="toggleAutoRefresh()" id="auto-refresh-btn" style="background: #17a2b8; color: white;">‚ñ∂Ô∏è –ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</button>
        </div>
    </div>
    
    <div class="stats-grid" style="margin-bottom: 20px;">
        <div class="stat-card">
            <div class="stat-icon">üìã</div>
            <div class="stat-info">
                <h3 id="logs-total">0</h3>
                <p>–í—Å–µ–≥–æ –ª–æ–≥–æ–≤</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">‚úÖ</div>
            <div class="stat-info">
                <h3 id="logs-success">0</h3>
                <p>–£—Å–ø–µ—à–Ω—ã—Ö</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">‚ùå</div>
            <div class="stat-info">
                <h3 id="logs-error">0</h3>
                <p>–û—à–∏–±–æ–∫</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">‚ö†Ô∏è</div>
            <div class="stat-info">
                <h3 id="logs-warning">0</h3>
                <p>–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π</p>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header" style="background: #1a1a2e; color: white; display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0; font-size: 16px;">üìã –õ–æ–≥–∏ —Å–∏—Å—Ç–µ–º—ã</h2>
            <div>
                <input type="text" id="log-filter" placeholder="üîç –§–∏–ª—å—Ç—Ä –ø–æ —Ç–µ–∫—Å—Ç—É..." 
                    style="padding: 5px 10px; border-radius: 5px; border: 1px solid #4a4a6a; background: #0f0f23; color: white; margin-right: 10px; width: 200px;">
                <select id="log-type-filter" style="padding: 5px 10px; border-radius: 5px; border: 1px solid #4a4a6a; background: #0f0f23; color: white; margin-right: 10px;">
                    <option value="all">–í—Å–µ —Ç–∏–ø—ã</option>
                    <option value="success">‚úÖ –£—Å–ø–µ—Ö</option>
                    <option value="error">‚ùå –û—à–∏–±–∫–∞</option>
                    <option value="warning">‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ</option>
                    <option value="info">‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</option>
                </select>
            </div>
        </div>
        <div id="logs-content" style="
            height: 600px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            padding: 10px;
            background: #0f0f23;
            color: #00ff00;
        ">
            <div style="color: #666;">üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤...</div>
        </div>
    </div>
</div>

<script>
    let autoRefreshInterval = null;
    let allLogs = [];
    
    // ========== FETCH –° –¢–ê–ô–ú–ê–£–¢–û–ú (—á—Ç–æ–±—ã –Ω–µ –∑–∞–≤–∏—Å–∞–ª–æ) ==========
    async function fetchWithTimeout(url, options = {}, timeout = 10000) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeout);
        
        try {
            const response = await fetch(url, {
                ...options,
                signal: controller.signal
            });
            clearTimeout(timeoutId);
            return response;
        } catch (error) {
            clearTimeout(timeoutId);
            if (error.name === 'AbortError') {
                throw new Error(`–¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ (${timeout}–º—Å): ${url}`);
            }
            throw error;
        }
    }
    
    async function loadLogs() {
        try {
            const res = await fetchWithTimeout('/api/v1/logs/all', {}, 8000);
            const data = await res.json();
            
            allLogs = data.logs || [];
            updateLogsDisplay();
            updateStats();
        } catch (error) {
            console.error('Error loading logs:', error);
            document.getElementById('logs-content').innerHTML = 
                '<div style="color: #ff4444;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤: ' + error.message + '</div>';
        }
    }
    
    function updateStats() {
        const total = allLogs.length;
        const success = allLogs.filter(l => l.type === 'success').length;
        const error = allLogs.filter(l => l.type === 'error').length;
        const warning = allLogs.filter(l => l.type === 'warning').length;
        
        document.getElementById('logs-total').textContent = total;
        document.getElementById('logs-success').textContent = success;
        document.getElementById('logs-error').textContent = error;
        document.getElementById('logs-warning').textContent = warning;
    }
    
    function updateLogsDisplay() {
        const logsDiv = document.getElementById('logs-content');
        const filterText = document.getElementById('log-filter').value.toLowerCase();
        const filterType = document.getElementById('log-type-filter').value;
        
        let filteredLogs = allLogs;
        
        // –§–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É
        if (filterType !== 'all') {
            filteredLogs = filteredLogs.filter(log => log.type === filterType);
        }
        
        // –§–∏–ª—å—Ç—Ä –ø–æ —Ç–µ–∫—Å—Ç—É
        if (filterText) {
            filteredLogs = filteredLogs.filter(log => 
                log.message.toLowerCase().includes(filterText)
            );
        }
        
        if (filteredLogs.length === 0) {
            logsDiv.innerHTML = '<div style="color: #666;">–ù–µ—Ç –ª–æ–≥–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>';
            return;
        }
        
        // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –ª–æ–≥–∏ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
        logsDiv.innerHTML = filteredLogs.slice().reverse().map(log => {
            let color = '#00ff00';
            let icon = 'üìù';
            if (log.type === 'error') { color = '#ff4444'; icon = '‚ùå'; }
            else if (log.type === 'warning') { color = '#ffaa00'; icon = '‚ö†Ô∏è'; }
            else if (log.type === 'success') { color = '#00ff88'; icon = '‚úÖ'; }
            else if (log.type === 'info') { color = '#00aaff'; icon = '‚ÑπÔ∏è'; }
            
            return `<div style="color: ${color}; margin-bottom: 3px; padding: 2px 0;">
                <span style="color: #666;">[${log.time}]</span> ${icon} ${escapeHtml(log.message)}
            </div>`;
        }).join('');
        
        // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑ (–∫ –Ω–æ–≤—ã–º –ª–æ–≥–∞–º)
        logsDiv.scrollTop = logsDiv.scrollHeight;
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    async function clearAllLogs() {
        if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å –í–°–ï –ª–æ–≥–∏? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) {
            return;
        }
        
        try {
            const res = await fetchWithTimeout('/api/v1/logs/all', { method: 'DELETE' }, 5000);
            const data = await res.json();
            
            if (res.ok) {
                alert('‚úÖ ' + data.message);
                loadLogs();
            } else {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + data.detail);
            }
        } catch (error) {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
        }
    }
    
    function toggleAutoRefresh() {
        const btn = document.getElementById('auto-refresh-btn');
        
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
            btn.textContent = '‚ñ∂Ô∏è –ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ';
            btn.style.background = '#17a2b8';
        } else {
            autoRefreshInterval = setInterval(loadLogs, 2000); // –û–±–Ω–æ–≤–ª—è—Ç—å –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
            btn.textContent = '‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
            btn.style.background = '#dc3545';
        }
    }
    
    // –§–∏–ª—å—Ç—Ä—ã
    document.getElementById('log-filter').addEventListener('input', updateLogsDisplay);
    document.getElementById('log-type-filter').addEventListener('change', updateLogsDisplay);
    
    // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–≥–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    loadLogs();
    
    // –ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    toggleAutoRefresh();
</script>

<style>
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .stat-card {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        border-radius: 10px;
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    
    .stat-icon {
        font-size: 32px;
    }
    
    .stat-info h3 {
        margin: 0;
        font-size: 24px;
        color: #fff;
    }
    
    .stat-info p {
        margin: 5px 0 0 0;
        color: #aaa;
        font-size: 12px;
    }
</style>
{% endblock %}

